var big_ugly_JSON = JSON.parse('{"device": {"width": 75.8, "name": "transposer_med", "height": 51}, "layers": {"c": {"z_offset": 1.2, "color": "Red", "features": ["urn:uuid:cab8a570-0529-4b3d-8811-c9ef6a9f8474", "urn:uuid:cab8a570-0529-4b3d-8811-c9ef6a9f8474", "urn:uuid:c8b4170a-011c-48b8-a343-3b2764241c72", "urn:uuid:c8b4170a-011c-48b8-a343-3b2764241c72", "urn:uuid:115e4267-e191-48f5-bae3-46c29e1cc5e9", "urn:uuid:115e4267-e191-48f5-bae3-46c29e1cc5e9", "urn:uuid:141874c6-1e8e-4318-921b-1839dcf7a132", "urn:uuid:141874c6-1e8e-4318-921b-1839dcf7a132", "urn:uuid:95abf00c-276c-4076-a4da-806e3a7ee723", "urn:uuid:95abf00c-276c-4076-a4da-806e3a7ee723", "urn:uuid:7121c61b-4c3b-4a90-86aa-17733f5d2f72", "urn:uuid:7121c61b-4c3b-4a90-86aa-17733f5d2f72", "urn:uuid:e33a6e89-f512-40e1-8b0e-361e7094369b", "urn:uuid:e33a6e89-f512-40e1-8b0e-361e7094369b", "urn:uuid:4d71e379-5a15-40ba-b856-1df8a67e7035", "urn:uuid:4d71e379-5a15-40ba-b856-1df8a67e7035", "urn:uuid:d491fc3b-0177-4463-a772-e9fd6f650124", "urn:uuid:d491fc3b-0177-4463-a772-e9fd6f650124", "urn:uuid:eacc4c92-3bff-4823-afb9-e3ae0acda9d9", "urn:uuid:eacc4c92-3bff-4823-afb9-e3ae0acda9d9", "urn:uuid:6ad663c8-5052-4f01-b0e1-6f040031cfe3", "urn:uuid:6ad663c8-5052-4f01-b0e1-6f040031cfe3", "urn:uuid:0e23d1ac-f894-4a42-a3b9-4868d77f3de3", "urn:uuid:af8e133f-7928-48bb-8b22-1b8eda6d1653", "urn:uuid:aa38734d-8910-4e2f-bc2a-d33c6de67d0b", "urn:uuid:7f9915ed-9034-4cff-9923-03f6a2d61d3c", "urn:uuid:caedf5bb-101a-4a77-906f-52fc2e20e46e", "urn:uuid:ceb065ef-0bb2-4b9c-92f3-b458e2e84d59", "urn:uuid:794ab2ed-be48-4cf3-a9b3-c22977caf2e7", "urn:uuid:930bafaf-e127-4ba7-b1c5-0cec4a7f1761", "urn:uuid:cd988816-da1e-446a-b5a5-4f7a21b7a53c", "urn:uuid:02957741-d87c-489b-b953-54f07e8ccd84", "urn:uuid:39e6b3e7-98e2-467d-9ce3-ea0cede6e1d3", "urn:uuid:83302134-27b5-4158-9049-6c17d80499fc", "urn:uuid:f7cc1f1b-3471-41c9-b158-b7b9617d62b4", "urn:uuid:9c086e0b-ca9d-49a3-ba43-0de5ca2af603"], "flip": true, "ID": "c"}, "f": {"z_offset": 0, "color": "Blue", "features": ["urn:uuid:77322625-d4de-437b-b029-482a2d7ce01a", "urn:uuid:77322625-d4de-437b-b029-482a2d7ce01a", "urn:uuid:311173ea-b107-4470-8d99-84b45d601d31", "urn:uuid:311173ea-b107-4470-8d99-84b45d601d31", "urn:uuid:94c29490-86b1-47e2-a4ca-f5a430cd05f2", "urn:uuid:94c29490-86b1-47e2-a4ca-f5a430cd05f2", "urn:uuid:0c843f74-776e-46ec-8ad2-eb61c5f5cab1", "urn:uuid:0c843f74-776e-46ec-8ad2-eb61c5f5cab1", "urn:uuid:ba61776e-c096-435f-b0eb-05406f8c7a85", "urn:uuid:ba61776e-c096-435f-b0eb-05406f8c7a85", "urn:uuid:014c0838-8374-4486-a74f-408b468b101e", "urn:uuid:52d1b909-b0a4-4501-b8a4-1773619f2d36", "urn:uuid:274745ba-39ca-48db-b36b-b1bc425bde87", "urn:uuid:445296c6-7ed1-431b-b572-3ae160d5fdda", "urn:uuid:25870ae1-bd3f-4a8b-bddd-93d443ba3ec5", "urn:uuid:2af27a70-1df9-4083-9964-6a9d9b29b125", "urn:uuid:f0cac6ae-3968-48fe-9f7e-6180bbe832d6", "urn:uuid:8dbdd414-9c9c-4280-93e9-dc740190d6e9", "urn:uuid:050766b3-0030-4b59-af1b-b7435097a378", "urn:uuid:ebba4f4d-7781-42a3-ad50-7e0ece688c74", "urn:uuid:88b86339-90f3-4ce4-99fd-db4da023bc49", "urn:uuid:27a31f61-f324-408b-8637-399e896fa057", "urn:uuid:6027ba05-218c-4e6b-bb32-b6e5948a9689", "urn:uuid:3c94c8fd-0c85-4362-aa1b-cce591e9ca9e"], "flip": false, "ID": "f"}}, "features": {"urn:uuid:311173ea-b107-4470-8d99-84b45d601d31": {"layer": "f", "end": [50.42, 31.02], "width": 0.41, "height": 0.1, "start": [30, 31.02], "type": "channel", "ID": "urn:uuid:311173ea-b107-4470-8d99-84b45d601d31"}, "urn:uuid:77322625-d4de-437b-b029-482a2d7ce01a": {"layer": "f", "end": [50.42, 20], "width": 0.41, "height": 0.1, "start": [30, 20], "type": "channel", "ID": "urn:uuid:77322625-d4de-437b-b029-482a2d7ce01a"}, "urn:uuid:e33a6e89-f512-40e1-8b0e-361e7094369b": {"layer": "c", "end": [31.405, 20], "width": 0.41, "height": 0.1, "start": [37.11, 20], "type": "channel", "ID": "urn:uuid:e33a6e89-f512-40e1-8b0e-361e7094369b"}, "urn:uuid:3c94c8fd-0c85-4362-aa1b-cce591e9ca9e": {"radius1": 1.2, "layer": "f", "radius2": 1.2, "height": 1.2, "position": [3, 48], "type": "standoff", "ID": "urn:uuid:3c94c8fd-0c85-4362-aa1b-cce591e9ca9e"}, "urn:uuid:2af27a70-1df9-4083-9964-6a9d9b29b125": {"radius1": 0.8, "layer": "f", "radius2": 0.7, "height": 1.0999999999999999, "position": [46.41, 25.509999999999998], "type": "via", "ID": "urn:uuid:2af27a70-1df9-4083-9964-6a9d9b29b125"}, "urn:uuid:94c29490-86b1-47e2-a4ca-f5a430cd05f2": {"layer": "f", "end": [40.21, 31.02], "width": 0.41, "height": 0.1, "start": [40.21, 20], "type": "channel", "ID": "urn:uuid:94c29490-86b1-47e2-a4ca-f5a430cd05f2"}, "urn:uuid:aa38734d-8910-4e2f-bc2a-d33c6de67d0b": {"layer": "c", "height": 0.1, "radius": 0.7, "position": [30, 20], "type": "port", "ID": "urn:uuid:aa38734d-8910-4e2f-bc2a-d33c6de67d0b"}, "urn:uuid:02957741-d87c-489b-b953-54f07e8ccd84": {"radius1": 1.4, "layer": "c", "radius2": 1.2, "height": 0.8999999999999999, "position": [43.31, 31.02], "type": "valve", "ID": "urn:uuid:02957741-d87c-489b-b953-54f07e8ccd84"}, "urn:uuid:27a31f61-f324-408b-8637-399e896fa057": {"radius1": 1.2, "layer": "f", "radius2": 1.2, "height": 1.2, "position": [72.8, 3], "type": "standoff", "ID": "urn:uuid:27a31f61-f324-408b-8637-399e896fa057"}, "urn:uuid:52d1b909-b0a4-4501-b8a4-1773619f2d36": {"layer": "f", "height": 0.1, "radius": 0.7, "position": [30, 31.02], "type": "port", "ID": "urn:uuid:52d1b909-b0a4-4501-b8a4-1773619f2d36"}, "urn:uuid:445296c6-7ed1-431b-b572-3ae160d5fdda": {"layer": "f", "height": 0.1, "radius": 0.7, "position": [50.42, 31.02], "type": "port", "ID": "urn:uuid:445296c6-7ed1-431b-b572-3ae160d5fdda"}, "urn:uuid:7f9915ed-9034-4cff-9923-03f6a2d61d3c": {"layer": "c", "height": 0.1, "radius": 0.7, "position": [30, 31.02], "type": "port", "ID": "urn:uuid:7f9915ed-9034-4cff-9923-03f6a2d61d3c"}, "urn:uuid:88b86339-90f3-4ce4-99fd-db4da023bc49": {"radius1": 1.2, "layer": "f", "radius2": 1.2, "height": 1.2, "position": [3, 3], "type": "standoff", "ID": "urn:uuid:88b86339-90f3-4ce4-99fd-db4da023bc49"}, "urn:uuid:794ab2ed-be48-4cf3-a9b3-c22977caf2e7": {"layer": "c", "height": 0.1, "radius": 0.7, "position": [47.92, 20], "type": "port", "ID": "urn:uuid:794ab2ed-be48-4cf3-a9b3-c22977caf2e7"}, "urn:uuid:cab8a570-0529-4b3d-8811-c9ef6a9f8474": {"layer": "c", "end": [46.41, 25.509999999999998], "width": 0.41, "height": 0.1, "start": [34.010000000000005, 25.509999999999998], "type": "channel", "ID": "urn:uuid:cab8a570-0529-4b3d-8811-c9ef6a9f8474"}, "urn:uuid:eacc4c92-3bff-4823-afb9-e3ae0acda9d9": {"layer": "c", "end": [47.92, 20], "width": 0.41, "height": 0.1, "start": [31.405, 20], "type": "channel", "ID": "urn:uuid:eacc4c92-3bff-4823-afb9-e3ae0acda9d9"}, "urn:uuid:caedf5bb-101a-4a77-906f-52fc2e20e46e": {"layer": "c", "height": 0.1, "radius": 0.7, "position": [50.42, 20], "type": "port", "ID": "urn:uuid:caedf5bb-101a-4a77-906f-52fc2e20e46e"}, "urn:uuid:274745ba-39ca-48db-b36b-b1bc425bde87": {"layer": "f", "height": 0.1, "radius": 0.7, "position": [50.42, 20], "type": "port", "ID": "urn:uuid:274745ba-39ca-48db-b36b-b1bc425bde87"}, "urn:uuid:ceb065ef-0bb2-4b9c-92f3-b458e2e84d59": {"layer": "c", "height": 0.1, "radius": 0.7, "position": [50.42, 31.02], "type": "port", "ID": "urn:uuid:ceb065ef-0bb2-4b9c-92f3-b458e2e84d59"}, "urn:uuid:8dbdd414-9c9c-4280-93e9-dc740190d6e9": {"radius1": 0.8, "layer": "f", "radius2": 0.7, "height": 1.0999999999999999, "position": [30, 31.02], "type": "via", "ID": "urn:uuid:8dbdd414-9c9c-4280-93e9-dc740190d6e9"}, "urn:uuid:115e4267-e191-48f5-bae3-46c29e1cc5e9": {"layer": "c", "end": [34.010000000000005, 22.605], "width": 0.41, "height": 0.1, "start": [40.21, 22.605], "type": "channel", "ID": "urn:uuid:115e4267-e191-48f5-bae3-46c29e1cc5e9"}, "urn:uuid:cd988816-da1e-446a-b5a5-4f7a21b7a53c": {"radius1": 1.4, "layer": "c", "radius2": 1.2, "height": 0.8999999999999999, "position": [37.11, 20], "type": "valve", "ID": "urn:uuid:cd988816-da1e-446a-b5a5-4f7a21b7a53c"}, "urn:uuid:f7cc1f1b-3471-41c9-b158-b7b9617d62b4": {"radius1": 1.4, "layer": "c", "radius2": 1.2, "height": 0.8999999999999999, "position": [34.010000000000005, 22.605], "type": "valve", "ID": "urn:uuid:f7cc1f1b-3471-41c9-b158-b7b9617d62b4"}, "urn:uuid:ebba4f4d-7781-42a3-ad50-7e0ece688c74": {"radius1": 0.8, "layer": "f", "radius2": 0.7, "height": 1.0999999999999999, "position": [50.42, 31.02], "type": "via", "ID": "urn:uuid:ebba4f4d-7781-42a3-ad50-7e0ece688c74"}, "urn:uuid:9c086e0b-ca9d-49a3-ba43-0de5ca2af603": {"radius1": 1.4, "layer": "c", "radius2": 1.2, "height": 0.8999999999999999, "position": [46.41, 28.415], "type": "valve", "ID": "urn:uuid:9c086e0b-ca9d-49a3-ba43-0de5ca2af603"}, "urn:uuid:6ad663c8-5052-4f01-b0e1-6f040031cfe3": {"layer": "c", "end": [50.42, 22.605], "width": 0.41, "height": 0.1, "start": [49.015, 22.605], "type": "channel", "ID": "urn:uuid:6ad663c8-5052-4f01-b0e1-6f040031cfe3"}, "urn:uuid:6027ba05-218c-4e6b-bb32-b6e5948a9689": {"radius1": 1.2, "layer": "f", "radius2": 1.2, "height": 1.2, "position": [72.8, 48], "type": "standoff", "ID": "urn:uuid:6027ba05-218c-4e6b-bb32-b6e5948a9689"}, "urn:uuid:014c0838-8374-4486-a74f-408b468b101e": {"layer": "f", "height": 0.1, "radius": 0.7, "position": [30, 20], "type": "port", "ID": "urn:uuid:014c0838-8374-4486-a74f-408b468b101e"}, "urn:uuid:0c843f74-776e-46ec-8ad2-eb61c5f5cab1": {"layer": "f", "end": [34.010000000000005, 25.509999999999998], "width": 0.41, "height": 0.1, "start": [34.010000000000005, 20], "type": "channel", "ID": "urn:uuid:0c843f74-776e-46ec-8ad2-eb61c5f5cab1"}, "urn:uuid:95abf00c-276c-4076-a4da-806e3a7ee723": {"layer": "c", "end": [49.015, 28.415], "width": 0.41, "height": 0.1, "start": [40.21, 28.415], "type": "channel", "ID": "urn:uuid:95abf00c-276c-4076-a4da-806e3a7ee723"}, "urn:uuid:c8b4170a-011c-48b8-a343-3b2764241c72": {"layer": "c", "end": [46.41, 28.415], "width": 0.41, "height": 0.1, "start": [40.21, 28.415], "type": "channel", "ID": "urn:uuid:c8b4170a-011c-48b8-a343-3b2764241c72"}, "urn:uuid:4d71e379-5a15-40ba-b856-1df8a67e7035": {"layer": "c", "end": [43.31, 31.02], "width": 0.41, "height": 0.1, "start": [31.405, 31.02], "type": "channel", "ID": "urn:uuid:4d71e379-5a15-40ba-b856-1df8a67e7035"}, "urn:uuid:af8e133f-7928-48bb-8b22-1b8eda6d1653": {"layer": "c", "height": 0.1, "radius": 0.7, "position": [46.41, 25.509999999999998], "type": "port", "ID": "urn:uuid:af8e133f-7928-48bb-8b22-1b8eda6d1653"}, "urn:uuid:39e6b3e7-98e2-467d-9ce3-ea0cede6e1d3": {"radius1": 1.4, "layer": "c", "radius2": 1.2, "height": 0.8999999999999999, "position": [40.21, 22.605], "type": "valve", "ID": "urn:uuid:39e6b3e7-98e2-467d-9ce3-ea0cede6e1d3"}, "urn:uuid:25870ae1-bd3f-4a8b-bddd-93d443ba3ec5": {"radius1": 0.8, "layer": "f", "radius2": 0.7, "height": 1.0999999999999999, "position": [34.010000000000005, 25.509999999999998], "type": "via", "ID": "urn:uuid:25870ae1-bd3f-4a8b-bddd-93d443ba3ec5"}, "urn:uuid:050766b3-0030-4b59-af1b-b7435097a378": {"radius1": 0.8, "layer": "f", "radius2": 0.7, "height": 1.0999999999999999, "position": [50.42, 20], "type": "via", "ID": "urn:uuid:050766b3-0030-4b59-af1b-b7435097a378"}, "urn:uuid:141874c6-1e8e-4318-921b-1839dcf7a132": {"layer": "c", "end": [49.015, 22.605], "width": 0.41, "height": 0.1, "start": [40.21, 22.605], "type": "channel", "ID": "urn:uuid:141874c6-1e8e-4318-921b-1839dcf7a132"}, "urn:uuid:f0cac6ae-3968-48fe-9f7e-6180bbe832d6": {"radius1": 0.8, "layer": "f", "radius2": 0.7, "height": 1.0999999999999999, "position": [30, 20], "type": "via", "ID": "urn:uuid:f0cac6ae-3968-48fe-9f7e-6180bbe832d6"}, "urn:uuid:0e23d1ac-f894-4a42-a3b9-4868d77f3de3": {"layer": "c", "height": 0.1, "radius": 0.7, "position": [34.010000000000005, 25.509999999999998], "type": "port", "ID": "urn:uuid:0e23d1ac-f894-4a42-a3b9-4868d77f3de3"}, "urn:uuid:83302134-27b5-4158-9049-6c17d80499fc": {"radius1": 1.4, "layer": "c", "radius2": 1.2, "height": 0.8999999999999999, "position": [40.21, 28.415], "type": "valve", "ID": "urn:uuid:83302134-27b5-4158-9049-6c17d80499fc"}, "urn:uuid:7121c61b-4c3b-4a90-86aa-17733f5d2f72": {"layer": "c", "end": [49.015, 28.415], "width": 0.41, "height": 0.1, "start": [49.015, 22.605], "type": "channel", "ID": "urn:uuid:7121c61b-4c3b-4a90-86aa-17733f5d2f72"}, "urn:uuid:d491fc3b-0177-4463-a772-e9fd6f650124": {"layer": "c", "end": [31.405, 31.02], "width": 0.41, "height": 0.1, "start": [31.405, 20], "type": "channel", "ID": "urn:uuid:d491fc3b-0177-4463-a772-e9fd6f650124"}, "urn:uuid:ba61776e-c096-435f-b0eb-05406f8c7a85": {"layer": "f", "end": [46.41, 25.509999999999998], "width": 0.41, "height": 0.1, "start": [46.41, 31.02], "type": "channel", "ID": "urn:uuid:ba61776e-c096-435f-b0eb-05406f8c7a85"}, "urn:uuid:930bafaf-e127-4ba7-b1c5-0cec4a7f1761": {"layer": "c", "height": 0.1, "radius": 0.7, "position": [50.42, 22.605], "type": "port", "ID": "urn:uuid:930bafaf-e127-4ba7-b1c5-0cec4a7f1761"}}}');
var another_big_ugly_JSON = JSON.parse('{"device": {"width": 75.8, "name": "transposer_large", "height": 51}, "layers": {"c": {"z_offset": 4, "color": "Red", "features": ["urn:uuid:9661fa60-9281-4e3e-8c02-fa42be789420", "urn:uuid:9661fa60-9281-4e3e-8c02-fa42be789420", "urn:uuid:75572e2b-89c4-4e2d-9742-0435359f20b8", "urn:uuid:75572e2b-89c4-4e2d-9742-0435359f20b8", "urn:uuid:0f9eadf4-0793-4932-8bea-c0604ba73683", "urn:uuid:0f9eadf4-0793-4932-8bea-c0604ba73683", "urn:uuid:d5309c96-6f61-48bc-8ff7-d414b465ee59", "urn:uuid:d5309c96-6f61-48bc-8ff7-d414b465ee59", "urn:uuid:3c3062be-8092-4f6f-8e24-231e853fd42e", "urn:uuid:3c3062be-8092-4f6f-8e24-231e853fd42e", "urn:uuid:644f2900-e725-41e9-8730-b2ed0bf14ac4", "urn:uuid:644f2900-e725-41e9-8730-b2ed0bf14ac4", "urn:uuid:6aea2961-5aa7-4900-98b8-c8e9824369a2", "urn:uuid:6aea2961-5aa7-4900-98b8-c8e9824369a2", "urn:uuid:2ec0933e-4550-45f7-9d0b-8354ea872753", "urn:uuid:2ec0933e-4550-45f7-9d0b-8354ea872753", "urn:uuid:f34ee43f-b3e2-4d44-9840-be58150bae20", "urn:uuid:f34ee43f-b3e2-4d44-9840-be58150bae20", "urn:uuid:091a5584-b90a-460b-b773-1842b8d49094", "urn:uuid:091a5584-b90a-460b-b773-1842b8d49094", "urn:uuid:c99920fd-9b25-4b8b-af0c-5c67b0d4610a", "urn:uuid:c99920fd-9b25-4b8b-af0c-5c67b0d4610a", "urn:uuid:97c2684a-7deb-4903-8f06-455e9bc169dd", "urn:uuid:500bd03e-c67c-4581-a2b0-20053112e271", "urn:uuid:a444e75c-10c4-4ab3-ac39-18ddbfdd360b", "urn:uuid:08b33d74-08f8-44cc-81b1-97882f2825b1", "urn:uuid:194f852f-ac6e-4291-b674-8057f5bb9af7", "urn:uuid:b8cb5752-60bf-45f3-985c-6c99b366b963", "urn:uuid:968c59ef-d4d2-45c3-92dc-846670607f35", "urn:uuid:c84ad3b2-7d29-4cac-a212-46e99ac211fa", "urn:uuid:16b439c1-cec1-410b-8ff0-a6fd6c07e339", "urn:uuid:c818825a-acce-4197-9cdf-f635cc2856b2", "urn:uuid:fced467b-cb79-4fa6-a766-6d841c8166bc", "urn:uuid:669fbe1d-5a2e-4d8d-b740-f0bb6dd55093", "urn:uuid:863e218e-8a0d-400f-8fc5-e5131ddb9a5e", "urn:uuid:2a592830-55f6-4a6f-aca5-28cd732f45ef"], "flip": true, "ID": "c"}, "f": {"z_offset": 0, "color": "Blue", "features": ["urn:uuid:e0c73c85-129a-410e-badb-25bd9e638d90", "urn:uuid:e0c73c85-129a-410e-badb-25bd9e638d90", "urn:uuid:624e198a-b002-4e48-b942-7631bc3da3dd", "urn:uuid:624e198a-b002-4e48-b942-7631bc3da3dd", "urn:uuid:46db8822-6832-479e-9aa5-54ee9b0b7577", "urn:uuid:46db8822-6832-479e-9aa5-54ee9b0b7577", "urn:uuid:3035f5b4-2af8-4c95-833d-4b937483b3ff", "urn:uuid:3035f5b4-2af8-4c95-833d-4b937483b3ff", "urn:uuid:58de9fb4-69de-4f1b-b503-945696b623ed", "urn:uuid:58de9fb4-69de-4f1b-b503-945696b623ed", "urn:uuid:a81c8987-dc07-4765-8c49-2223bca23785", "urn:uuid:bee7cf18-4090-4d22-b5e0-3be893bccd93", "urn:uuid:05151f9c-84aa-4cf3-950a-698e574d8f6c", "urn:uuid:d48f818b-3333-445c-96f2-8537ebad9a16", "urn:uuid:128aee57-a968-4253-82af-e32dc3150e8a", "urn:uuid:c43a24f3-b8e0-484c-b28f-a65aaaf946a0", "urn:uuid:a9b03c2e-4c33-4447-8e09-15c3a5a62fdd", "urn:uuid:5f84e646-b7a3-4e8f-8033-5cccb102f41e", "urn:uuid:31979add-f2ec-408c-977b-f4f75c9e28af", "urn:uuid:ee25e782-9941-4ca4-8ead-8a9bca2c8726", "urn:uuid:ebbc25ff-2b38-4355-912d-ec58be7adfff", "urn:uuid:a87b26d6-e2cc-4fba-bd78-cdd607f63b13", "urn:uuid:5583b2aa-1f56-40c9-9b3d-e20e6114f45b", "urn:uuid:c511390e-514f-41a5-ad69-82e5ed1c7dc0"], "flip": false, "ID": "f"}}, "features": {"urn:uuid:194f852f-ac6e-4291-b674-8057f5bb9af7": {"layer": "c", "height": 0.5, "radius": 1.6, "position": [67.2, 10], "type": "port", "ID": "urn:uuid:194f852f-ac6e-4291-b674-8057f5bb9af7"}, "urn:uuid:968c59ef-d4d2-45c3-92dc-846670607f35": {"layer": "c", "height": 0.5, "radius": 1.6, "position": [60.2, 10], "type": "port", "ID": "urn:uuid:968c59ef-d4d2-45c3-92dc-846670607f35"}, "urn:uuid:3035f5b4-2af8-4c95-833d-4b937483b3ff": {"layer": "f", "end": [22.8, 25.1], "width": 2, "height": 0.5, "start": [22.8, 10], "type": "channel", "ID": "urn:uuid:3035f5b4-2af8-4c95-833d-4b937483b3ff"}, "urn:uuid:863e218e-8a0d-400f-8fc5-e5131ddb9a5e": {"radius1": 3, "layer": "c", "radius2": 2.4, "height": 3.0, "position": [22.8, 17.4], "type": "valve", "ID": "urn:uuid:863e218e-8a0d-400f-8fc5-e5131ddb9a5e"}, "urn:uuid:05151f9c-84aa-4cf3-950a-698e574d8f6c": {"layer": "f", "height": 0.5, "radius": 1.6, "position": [67.2, 10], "type": "port", "ID": "urn:uuid:05151f9c-84aa-4cf3-950a-698e574d8f6c"}, "urn:uuid:a444e75c-10c4-4ab3-ac39-18ddbfdd360b": {"layer": "c", "height": 0.5, "radius": 1.6, "position": [10, 10], "type": "port", "ID": "urn:uuid:a444e75c-10c4-4ab3-ac39-18ddbfdd360b"}, "urn:uuid:e0c73c85-129a-410e-badb-25bd9e638d90": {"layer": "f", "end": [67.2, 10], "width": 2, "height": 0.5, "start": [10, 10], "type": "channel", "ID": "urn:uuid:e0c73c85-129a-410e-badb-25bd9e638d90"}, "urn:uuid:ebbc25ff-2b38-4355-912d-ec58be7adfff": {"radius1": 3, "layer": "f", "radius2": 2.4, "height": 4, "position": [3, 3], "type": "standoff", "ID": "urn:uuid:ebbc25ff-2b38-4355-912d-ec58be7adfff"}, "urn:uuid:0f9eadf4-0793-4932-8bea-c0604ba73683": {"layer": "c", "end": [22.8, 17.4], "width": 2, "height": 0.5, "start": [38.6, 17.4], "type": "channel", "ID": "urn:uuid:0f9eadf4-0793-4932-8bea-c0604ba73683"}, "urn:uuid:c99920fd-9b25-4b8b-af0c-5c67b0d4610a": {"layer": "c", "end": [67.2, 17.4], "width": 2, "height": 0.5, "start": [61.8, 17.4], "type": "channel", "ID": "urn:uuid:c99920fd-9b25-4b8b-af0c-5c67b0d4610a"}, "urn:uuid:c818825a-acce-4197-9cdf-f635cc2856b2": {"radius1": 3, "layer": "c", "radius2": 2.4, "height": 3.0, "position": [46.5, 40.2], "type": "valve", "ID": "urn:uuid:c818825a-acce-4197-9cdf-f635cc2856b2"}, "urn:uuid:b8cb5752-60bf-45f3-985c-6c99b366b963": {"layer": "c", "height": 0.5, "radius": 1.6, "position": [67.2, 40.2], "type": "port", "ID": "urn:uuid:b8cb5752-60bf-45f3-985c-6c99b366b963"}, "urn:uuid:97c2684a-7deb-4903-8f06-455e9bc169dd": {"layer": "c", "height": 0.5, "radius": 1.6, "position": [22.8, 25.1], "type": "port", "ID": "urn:uuid:97c2684a-7deb-4903-8f06-455e9bc169dd"}, "urn:uuid:c84ad3b2-7d29-4cac-a212-46e99ac211fa": {"layer": "c", "height": 0.5, "radius": 1.6, "position": [67.2, 17.4], "type": "port", "ID": "urn:uuid:c84ad3b2-7d29-4cac-a212-46e99ac211fa"}, "urn:uuid:08b33d74-08f8-44cc-81b1-97882f2825b1": {"layer": "c", "height": 0.5, "radius": 1.6, "position": [10, 40.2], "type": "port", "ID": "urn:uuid:08b33d74-08f8-44cc-81b1-97882f2825b1"}, "urn:uuid:2ec0933e-4550-45f7-9d0b-8354ea872753": {"layer": "c", "end": [46.5, 40.2], "width": 2, "height": 0.5, "start": [15.400000000000002, 40.2], "type": "channel", "ID": "urn:uuid:2ec0933e-4550-45f7-9d0b-8354ea872753"}, "urn:uuid:500bd03e-c67c-4581-a2b0-20053112e271": {"layer": "c", "height": 0.5, "radius": 1.6, "position": [54.400000000000006, 25.1], "type": "port", "ID": "urn:uuid:500bd03e-c67c-4581-a2b0-20053112e271"}, "urn:uuid:624e198a-b002-4e48-b942-7631bc3da3dd": {"layer": "f", "end": [67.2, 40.2], "width": 2, "height": 0.5, "start": [10, 40.2], "type": "channel", "ID": "urn:uuid:624e198a-b002-4e48-b942-7631bc3da3dd"}, "urn:uuid:46db8822-6832-479e-9aa5-54ee9b0b7577": {"layer": "f", "end": [38.6, 40.2], "width": 2, "height": 0.5, "start": [38.6, 10], "type": "channel", "ID": "urn:uuid:46db8822-6832-479e-9aa5-54ee9b0b7577"}, "urn:uuid:58de9fb4-69de-4f1b-b503-945696b623ed": {"layer": "f", "end": [54.400000000000006, 25.1], "width": 2, "height": 0.5, "start": [54.400000000000006, 40.2], "type": "channel", "ID": "urn:uuid:58de9fb4-69de-4f1b-b503-945696b623ed"}, "urn:uuid:d48f818b-3333-445c-96f2-8537ebad9a16": {"layer": "f", "height": 0.5, "radius": 1.6, "position": [67.2, 40.2], "type": "port", "ID": "urn:uuid:d48f818b-3333-445c-96f2-8537ebad9a16"}, "urn:uuid:669fbe1d-5a2e-4d8d-b740-f0bb6dd55093": {"radius1": 3, "layer": "c", "radius2": 2.4, "height": 3.0, "position": [38.6, 32.800000000000004], "type": "valve", "ID": "urn:uuid:669fbe1d-5a2e-4d8d-b740-f0bb6dd55093"}, "urn:uuid:a9b03c2e-4c33-4447-8e09-15c3a5a62fdd": {"radius1": 2, "layer": "f", "radius2": 1.6, "height": 3.5, "position": [10, 10], "type": "via", "ID": "urn:uuid:a9b03c2e-4c33-4447-8e09-15c3a5a62fdd"}, "urn:uuid:a87b26d6-e2cc-4fba-bd78-cdd607f63b13": {"radius1": 3, "layer": "f", "radius2": 2.4, "height": 4, "position": [72.8, 3], "type": "standoff", "ID": "urn:uuid:a87b26d6-e2cc-4fba-bd78-cdd607f63b13"}, "urn:uuid:c511390e-514f-41a5-ad69-82e5ed1c7dc0": {"radius1": 3, "layer": "f", "radius2": 2.4, "height": 4, "position": [3, 48], "type": "standoff", "ID": "urn:uuid:c511390e-514f-41a5-ad69-82e5ed1c7dc0"}, "urn:uuid:6aea2961-5aa7-4900-98b8-c8e9824369a2": {"layer": "c", "end": [15.400000000000002, 10], "width": 2, "height": 0.5, "start": [30.700000000000003, 10], "type": "channel", "ID": "urn:uuid:6aea2961-5aa7-4900-98b8-c8e9824369a2"}, "urn:uuid:9661fa60-9281-4e3e-8c02-fa42be789420": {"layer": "c", "end": [54.400000000000006, 25.1], "width": 2, "height": 0.5, "start": [22.8, 25.1], "type": "channel", "ID": "urn:uuid:9661fa60-9281-4e3e-8c02-fa42be789420"}, "urn:uuid:bee7cf18-4090-4d22-b5e0-3be893bccd93": {"layer": "f", "height": 0.5, "radius": 1.6, "position": [10, 40.2], "type": "port", "ID": "urn:uuid:bee7cf18-4090-4d22-b5e0-3be893bccd93"}, "urn:uuid:f34ee43f-b3e2-4d44-9840-be58150bae20": {"layer": "c", "end": [15.400000000000002, 40.2], "width": 2, "height": 0.5, "start": [15.400000000000002, 10], "type": "channel", "ID": "urn:uuid:f34ee43f-b3e2-4d44-9840-be58150bae20"}, "urn:uuid:a81c8987-dc07-4765-8c49-2223bca23785": {"layer": "f", "height": 0.5, "radius": 1.6, "position": [10, 10], "type": "port", "ID": "urn:uuid:a81c8987-dc07-4765-8c49-2223bca23785"}, "urn:uuid:3c3062be-8092-4f6f-8e24-231e853fd42e": {"layer": "c", "end": [61.8, 32.800000000000004], "width": 2, "height": 0.5, "start": [38.6, 32.800000000000004], "type": "channel", "ID": "urn:uuid:3c3062be-8092-4f6f-8e24-231e853fd42e"}, "urn:uuid:2a592830-55f6-4a6f-aca5-28cd732f45ef": {"radius1": 3, "layer": "c", "radius2": 2.4, "height": 3.0, "position": [54.400000000000006, 32.800000000000004], "type": "valve", "ID": "urn:uuid:2a592830-55f6-4a6f-aca5-28cd732f45ef"}, "urn:uuid:c43a24f3-b8e0-484c-b28f-a65aaaf946a0": {"radius1": 2, "layer": "f", "radius2": 1.6, "height": 3.5, "position": [54.400000000000006, 25.1], "type": "via", "ID": "urn:uuid:c43a24f3-b8e0-484c-b28f-a65aaaf946a0"}, "urn:uuid:75572e2b-89c4-4e2d-9742-0435359f20b8": {"layer": "c", "end": [54.400000000000006, 32.800000000000004], "width": 2, "height": 0.5, "start": [38.6, 32.800000000000004], "type": "channel", "ID": "urn:uuid:75572e2b-89c4-4e2d-9742-0435359f20b8"}, "urn:uuid:d5309c96-6f61-48bc-8ff7-d414b465ee59": {"layer": "c", "end": [61.8, 17.4], "width": 2, "height": 0.5, "start": [38.6, 17.4], "type": "channel", "ID": "urn:uuid:d5309c96-6f61-48bc-8ff7-d414b465ee59"}, "urn:uuid:5f84e646-b7a3-4e8f-8033-5cccb102f41e": {"radius1": 2, "layer": "f", "radius2": 1.6, "height": 3.5, "position": [10, 40.2], "type": "via", "ID": "urn:uuid:5f84e646-b7a3-4e8f-8033-5cccb102f41e"}, "urn:uuid:fced467b-cb79-4fa6-a766-6d841c8166bc": {"radius1": 3, "layer": "c", "radius2": 2.4, "height": 3.0, "position": [38.6, 17.4], "type": "valve", "ID": "urn:uuid:fced467b-cb79-4fa6-a766-6d841c8166bc"}, "urn:uuid:091a5584-b90a-460b-b773-1842b8d49094": {"layer": "c", "end": [60.2, 10], "width": 2, "height": 0.5, "start": [15.400000000000002, 10], "type": "channel", "ID": "urn:uuid:091a5584-b90a-460b-b773-1842b8d49094"}, "urn:uuid:644f2900-e725-41e9-8730-b2ed0bf14ac4": {"layer": "c", "end": [61.8, 32.800000000000004], "width": 2, "height": 0.5, "start": [61.8, 17.4], "type": "channel", "ID": "urn:uuid:644f2900-e725-41e9-8730-b2ed0bf14ac4"}, "urn:uuid:ee25e782-9941-4ca4-8ead-8a9bca2c8726": {"radius1": 2, "layer": "f", "radius2": 1.6, "height": 3.5, "position": [67.2, 40.2], "type": "via", "ID": "urn:uuid:ee25e782-9941-4ca4-8ead-8a9bca2c8726"}, "urn:uuid:128aee57-a968-4253-82af-e32dc3150e8a": {"radius1": 2, "layer": "f", "radius2": 1.6, "height": 3.5, "position": [22.8, 25.1], "type": "via", "ID": "urn:uuid:128aee57-a968-4253-82af-e32dc3150e8a"}, "urn:uuid:31979add-f2ec-408c-977b-f4f75c9e28af": {"radius1": 2, "layer": "f", "radius2": 1.6, "height": 3.5, "position": [67.2, 10], "type": "via", "ID": "urn:uuid:31979add-f2ec-408c-977b-f4f75c9e28af"}, "urn:uuid:16b439c1-cec1-410b-8ff0-a6fd6c07e339": {"radius1": 3, "layer": "c", "radius2": 2.4, "height": 3.0, "position": [30.700000000000003, 10], "type": "valve", "ID": "urn:uuid:16b439c1-cec1-410b-8ff0-a6fd6c07e339"}, "urn:uuid:5583b2aa-1f56-40c9-9b3d-e20e6114f45b": {"radius1": 3, "layer": "f", "radius2": 2.4, "height": 4, "position": [72.8, 48], "type": "standoff", "ID": "urn:uuid:5583b2aa-1f56-40c9-9b3d-e20e6114f45b"}}}');

var canvas = new fabric.CanvasWithViewport('c');
canvas.isGrabMode = false;
var selectedItem = null;
var fabric_features = {};
var features = {};
var layers = {};
var default_radius = 5;
var device_width = 70;
var device_height = 55;
var device_name = "Default_Device";
canvas.setZoom(canvas.viewport.zoom*10);
canvas.viewport.position = new fabric.Point(0,0);
var border = new fabric.Rect({left: 0, top:0, width: device_width, height: device_height, fill:'white', strokeWidth: 1, stroke:'black'});
canvas.add(border);
border.set({'selectable': false})

if (document.addEventListener) {
  // IE9, Chrome, Safari, Opera
  document.addEventListener("mousewheel", MouseWheelHandler, false);
  // Firefox
  document.addEventListener("DOMMouseScroll", MouseWheelHandler, false);
}
// IE 6/7/8
else document.attachEvent("onmousewheel", MouseWheelHandler);

function MouseWheelHandler(e) {

  // cross-browser wheel delta
  var e = window.event || e; // old IE support
  var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));
  if (delta > 0)
  {
    console.log("UP");
    canvas.setZoom(canvas.viewport.zoom*1.1);
  }
  else
  {
    console.log("DOWN");
    canvas.setZoom(canvas.viewport.zoom/1.1);
  }
  return false;
}

var merge = function() {
    var obj = {},
        i = 0,
        il = arguments.length,
        key;
    for (; i < il; i++) {
        for (key in arguments[i]) {
            if (arguments[i].hasOwnProperty(key)) {
                obj[key] = arguments[i][key];
            }
        }
    }
    return obj;
};

var feature = function(feature_data){
  this.layer = feature_data["target_layer"];
  this.ID = feature_data["ID"];
  this.featureType = feature_data["type"];
  if (feature_data["color"])
  {
    this.color = feature_data["color"];
  }
  else {
    this.color = layers[this.layer].color;
  }
}

feature.prototype.updateFabColor = function()
{
  if (this.fab)
  {
    this.fab.set({fill: this.color, stroke: this.color});
  }
  else {
    console.log("No fab to update for feature: " + this.ID);
  }
}

feature.prototype.feature_data = function(){
    var data = {};
    data["color"] = this.color;
    data["layer"] = this.layer;
    data["ID"] = this.ID;
    data["type"] = this.featureType;
    return data;
  };

var layer = function(layer_data){
    this.z_offset = layer_data["z_offset"];
    this.flip = layer_data["flip"];
    this.fabric_features = [];
    this.color = layer_data["color"];
    this.ID = layer_data["ID"];
  

  this.JSON_data = function()
  {
    var data = {};
    data["flip"] = this.flip;
    data["z_offset"] = this.z_offset;
    data["ID"] = this.ID;
    data["color"] = this.color;
    data["features"] = this.fabric_features;
    return data;
  }
}

var flipY = function(position)
{
  return [position[0], device_height - position[1]];
}

var via = function(feature_data){
    feature.call(this, {target_layer: feature_data["layer"], ID: feature_data["ID"], type: "via", color: feature_data["color"]});
    this.position = feature_data["position"];
    this.radius1 = feature_data["radius1"];
    this.radius2 = feature_data["radius2"];
    this.height = feature_data["height"];

  this.fab = new fabric.Circle({top: flipY(this.position)[1], left: this.position[0], radius: this.radius1, lockRotation: true, 
    originX: 'center', originY: 'center', fill: 'purple', lockUniScaling: true, originX: 'center', originY: 'center', strokeWidth: 0});
  this.updateFabColor();


  this.update = function()
  {
    this.position = flipY([this.fab.left, this.fab.top]);
    this.radius1 = this.fab.radius;
  }

  this.updateFab = function()
  {
    this.fab.set({radius: this.radius1, left: this.position[0], top: this.position[1]});
    this.updateFabColor();
  }

  this.JSON_data = function(){
    var data = {}
    data["position"] = this.position;
    data["radius1"] = this.radius1;
    data["radius2"] = this.radius2;
    data["height"] = this.height;
    return merge(data, this.feature_data());
  }
}

via.prototype = Object.create(feature.prototype);
via.prototype.constructor = via;

var grabber = function(position, parent){
  this.featureType = "grabber"
  this.strokeWidth = 1
  this.radius = parent.fab['strokeWidth'] * .75;
  this.fab = new fabric.Circle({top: flipY(position)[1], left: position[0], hasBorders: false, hasControls: false,
    fill:'rgba(255,255,255,.5)', stroke: '#22F', strokeWidth: this.strokeWidth, radius: this.radius,
    originX: 'center', originY: 'center'});
  this.position = function(){
    return flipY([this.fab.left, this.fab.top]);
  }
  this.parent = parent;
}

var channel = function(feature_data)
{
  feature.call(this, {target_layer: feature_data["layer"], ID: feature_data["ID"], type: "channel", color: feature_data["color"]});
  this.grabbers = {}
  this.height = feature_data["height"];
  this.start = feature_data["start"];
  this.end = feature_data["end"];
  this.width = feature_data["width"];

  this.toFab = function(coords)
  {
    coords = [this.start[0], flipY(this.start)[1], this.end[0], flipY(this.end)[1]]
    return new fabric.Line(coords, {fill: 'red', stroke: 'red',
    strokeWidth: this.width, selectable: true, hasControls: false, lockScalingX: true, 
    lockScalingY: true, centeredScaling: true, originY: 'center', originX: 'center', 
    lockMovementX: true, lockMovementY: true, lockRotation: true});
  }

  this.fab = this.toFab()
  this.updateFabColor();

  this.update = function()
  {
    this.start = flipY([this.fab.x1, this.fab.y1]);
    this.end = flipY([this.fab.x2, this.fab.y2]);
    this.width = this.fab.strokeWidth * this.fab.scaleY;
  }

  this.makeGrabbers = function(canvas, fabric_features){
    if (this.grabbers['start'] == null && this.grabbers['end'] == null)
    {
      start = new grabber(this.start, this);
      start.fab.ID = this.ID + "_start_grabber";
      this.grabbers['start'] = start;
      canvas.add(start.fab);
      fabric_features[start.fab.ID] = start;
      end = new grabber(this.end, this);
      end.fab.ID = this.ID + "_end_grabber";
      this.grabbers['end'] = end;
      fabric_features[end.fab.ID] = end;
      canvas.add(end.fab);
    }
  }
  this.killGrabbers = function(canvas, fabric_features){
    if (this.grabbers['start']){
      canvas.remove(this.grabbers['start'].fab);
      fabric_features[this.grabbers['start'].fab.ID] = null;
      this.grabbers['start'] = null;
    }
    if (this.grabbers['end']){
      canvas.remove(this.grabbers['end'].fab);
      fabric_features[this.grabbers['end'].fab.ID] = null;
      this.grabbers['end'] = null;
    }
  }
  this.updateEnds = function(){
    if (this.grabbers['start']){
      var pos = flipY(this.grabbers['start'].position());
      this.fab.set({'x1': pos[0], 'y1': pos[1]});
    }
    if (this.grabbers['end']){
      var pos = flipY(this.grabbers['end'].position());
      this.fab.set({'x2': pos[0], 'y2': pos[1]});
    }
    this.update();
    canvas.remove(this.fab);
    canvas.add(this.fab);
  }
  this.JSON_data = function(){
    var data = {}
    data["start"] = flipY(this.start);
    data["end"] = flipY(this.end);
    data["width"] = this.width;
    data["height"] = this.height;
    return merge(data, this.feature_data());
  }
  return this;
}

channel.prototype = Object.create(feature.prototype);
channel.prototype.constructor = channel;

var valve = function(feature_data)
{
  feature.call(this, {target_layer: feature_data["layer"], ID: feature_data["ID"], type: "valve", color: feature_data["color"]});
  this.radius1 = feature_data["radius1"];
  this.radius2 = feature_data["radius2"];
  this.position = feature_data["position"];
  this.height = feature_data["height"];
  this.fab = new fabric.Circle({radius: this.radius1, fill:'#f55', left: this.position[0], top: flipY(this.position)[1], lockUniScaling: true, lockRotation: true, centeredScaling: true, originX: 'center', originY: 'center', strokeWidth: 0});
  this.updateFabColor();

  this.update = function()
  {
    this.radius1 = this.fab.radius * this.fab.scaleX;
    this.position = flipY([this.fab.left, this.fab.top]);
  }
  this.JSON_data = function()
  {
    var data = {}
    data["position"] = this.position;
    data["radius1"] = this.radius1;
    data["radius2"] = this.radius2;
    data["height"] = this.height;
    return merge(data, this.feature_data());
  }
  this.json
  return this;
}

valve.prototype = Object.create(feature.prototype);
valve.prototype.constructor = valve;

var standoff = function(feature_data)
{
  feature.call(this, {target_layer: feature_data["layer"], ID: feature_data["ID"], type: "standoff", color: feature_data["color"]});
  this.radius1 = feature_data["radius1"];
  this.radius2 = feature_data["radius2"];
  this.position = feature_data["position"];
  this.height = feature_data["height"];
  this.fab = new fabric.Circle({radius: this.radius1, fill:'yellow', left: this.position[0], top: flipY(this.position)[1], lockUniScaling: true, lockRotation: true, centeredScaling: true, originX: 'center', originY: 'center', strokeWidth: 0});
  this.updateFabColor();

  this.update = function()
  {
    this.radius1 = this.fab.radius * this.fab.scaleX;
    this.position = flipY([this.fab.left, this.fab.top]);
  }
  this.JSON_data = function()
  {
    var data = {}
    data["position"] = flipY(this.position);
    data["radius1"] = this.radius1;
    data["radius2"] = this.radius2;
    data["height"] = this.height;
    return merge(data, this.feature_data());
  }
  return this;
}

standoff.prototype = Object.create(feature.prototype);
standoff.prototype.constructor = standoff;

valve.prototype = Object.create(feature.prototype);
valve.prototype.constructor = valve;

var label = function(feature_data)
{
  feature.call(this, {target_layer: feature_data["layer"], ID: feature_data["ID"], type: "label", color: feature_data["color"]});
  this.position = feature_data["position"];
  this.text = feature_data["text"];
  this.height = feature_data["height"];
  this.fab = new fabric.Text(this.text, {left: this.position[0], top: flipY(this.position)[1], hasControls: false, lockUniScaling: true, lockRotation: true, centeredScaling: true, originX: 'center', originY: 'center', strokeWidth: 0});
  this.updateFabColor();

  this.update = function()
  {
    this.position = flipY([this.fab.left, this.fab.top]);
    this.text = this.fab.text;
  }
  this.JSON_data = function()
  {
    var data = {}
    data["position"] = this.position;
    data["label_text"] = this.text;
    data["height"] = this.height;
    return merge(data, this.feature_data());
  }
  return this;
}

label.prototype = Object.create(feature.prototype);
label.prototype.constructor = label;

var port = function(feature_data)
{
  feature.call(this, {target_layer: feature_data["layer"], ID: feature_data["ID"], type: "port", color: feature_data["color"]});
  this.radius = feature_data["radius"];
  this.position = feature_data["position"];
  this.height = feature_data["height"];
  this.fab = new fabric.Circle({radius: this.radius, fill:'green', left: this.position[0], top: flipY(this.position)[1], lockUniScaling: true, lockRotation: true, centeredScaling: true, originX: 'center', originY: 'center', strokeWidth: 0});
  this.updateFabColor();

  this.update = function()
  {
    this.radius = this.fab.radius * this.fab.scaleX;
    this.position = flipY([this.fab.left, this.fab.top]);
  }
  this.JSON_data = function()
  {
    var data = {}
    data["position"] = this.position;
    data["radius"] = this.radius;
    data["height"] = this.height;
    return merge(data, this.feature_data());
  }
  return this;
}

port.prototype = Object.create(feature.prototype);
port.prototype.constructor = port;

document.addEventListener('keydown', function(event){
	if (event.keyCode == 8 || event.keyCode == 46){
		if (selectedItem != null){

			selectedItem.remove();
		}
	}
	else if (event.keyCode == 16){
		alert(JSON.stringify(canvas));
	}
  else if (event.keyCode == 18)
  {
    if (selectedItem != null ){
      v = fabric_features[selectedItem]
      alert(v.reportString());
    }
  }
  });

var addFeature = function(feature){
  feature.fab.ID = feature.ID;
  fabric_features[feature.fab.ID] = feature;
  layers[feature.layer].fabric_features.push(feature.ID);
  canvas.add(feature.fab);
  features[feature.ID] = feature;
}

var addLayer = function(layer){
  layers[layer.ID] = layer;
}

var removeFeature = function(feature){
  if (fabric_features[feature]){
      fabric_features[feature] = null;
  }
  features[feature.ID] = null;
  canvas.remove(feature.fab);
  layer_fabric_features = layers[feature.layer].fabric_features;
  index = layer_fabric_features.indexOf(feature.ID);
  if (index > -1){
    layer_fabric_features.splice(index, 1);
  }
}

var load_device_data = function(device_data)
{
  device_height = device_data["height"];
  device_width = device_data["width"];
  device_name = device_data["name"];
}

var device_data = function()
{
  var data = {}
  data["width"] = device_width;
  data["height"] = device_height;
  data["name"] = device_name;
  return data;
}

var layer_data = function()
{
  var data = {}
  for (var layer_ID in layers)
  {
    var layer = layers[layer_ID];
    var layerData = layer.JSON_data();
    data[layer_ID] = layerData;
  }
  return data;
}

var load_feature = function(target_feature)
{
  var type = target_feature["type"];
  var fn = window[type];
  new_feature = new fn(target_feature);
  addFeature(new_feature);  
}

var load_layer_data = function(layer_data)
{
  for (var target_layer in layer_data)
  {
    load_layer(layer_data[target_layer]);
  }
}

var feature_data = function()
{
  var data = {}
  for (var feature_ID in features){
    data[feature_ID] = features[feature_ID].JSON_data();
  }
  return data;
}

var load_feature_data = function(feature_data)
{
  for (var feature in feature_data)
  {
    load_feature(feature_data[feature]);
  }
}

var makeJSON = function()
{
   var JSON_data = {};
   JSON_data["device"] = device_data();
   JSON_data["features"] = feature_data();
   JSON_data["layers"] = layer_data();
  // console.log(layer_data());
   return JSON_data;
}

var clear_data = function()
{
  canvas.clear();
  fabric_features = {};
  layers = {};
  features = {};
  selectedItem = null;
}

var loadJSON = function(json_object)
{
  clear_data();
  load_device_data(json_object["device"]);
  border.set({width: device_width, height: device_height});
  canvas.add(border);
  load_layer_data(json_object["layers"]);
  load_feature_data(json_object["features"]);

}

var load_layer = function(target_layer)
{
  var l = new layer(target_layer);
  addLayer(l);
}


var foo = new layer({z_offset: 0, ID: "foo", flip: false, color: "blue"});
addLayer(foo);
var chan = new channel({start:[10,20], end:[6,20], width:1.0, height:1, layer: "foo", ID:'chan'});
var via1 = new via({position:[15,30], radius1:1.0, radius2:2, layer: "foo", ID:'via1'});
var val1 = new valve({position:[20,20], radius1:2.0, radius2:3, layer: "foo", ID:'val1'});
var port1 = new port({position:[40,10], radius:1.0, layer: "foo", ID:'port1'});
var sta1 = new standoff({position:[5,50], radius1:2.0, radius2:3, layer: "foo", ID:'sta1'});
addFeature(chan)
addFeature(via1)
addFeature(sta1)
addFeature(val1)
addFeature(port1)
var json_data = makeJSON();
//console.log(JSON.stringify(json_data));
loadJSON(big_ugly_JSON);


//chan.makeGrabbers(canvas, fabric_features);
canvas.on('object:moving', function(e){
  p = e.target;
  if (fabric_features[p.ID]){
    var feature = fabric_features[p.ID];
    if (feature.featureType == "grabber"){
      console.log("Moving a grabber!");
      parent = feature.parent;
      if (parent.featureType == "channel"){
        parent.updateEnds();
      }
    }
    else {
      feature.update();
    }
  }
});

canvas.on('mouse:down', function(options){
	if (!options.target || options.target == border)
	{
    console.log("Clicked on nothing...");
    if (selectedItem)
    {
      if (selectedItem.featureType == "channel"){
        console.log("Last selection was a channel, removing grabbers.");
        selectedItem.killGrabbers(canvas, fabric_features);
      }
    }
    if (selectedItem != null)
    {
      console.log("Clearing selection");
	   	selectedItem = null;
    }
	}
	else {
    console.log("Clicked on something!");
    var current = fabric_features[options.target.ID];
    if (current)
    {
      console.log("Current: " + current["ID"]);
      if (selectedItem != null)
      {
        console.log("Selected: " + selectedItem["ID"]);
      }
      if (selectedItem == null || current["ID"] != selectedItem["ID"])
      {
        console.log("Clicked on a new feature");
        if (current.featureType == "channel"){
          console.log("New feature is a channel");
          current.makeGrabbers(canvas, fabric_features);
        }
        if (selectedItem != null && selectedItem.featureType == "channel" && current.featureType != "grabber")
        {
          console.log("Last selection was a channel, removing grabbers.");
          selectedItem.killGrabbers(canvas, fabric_features);
        }
        if (current.featureType != "grabber"){
          console.log("Updating selection...");
          selectedItem = current;
        }
      }
      else {

      }
    }
	}
});

