var test_json = JSON.parse('{"device": {"width": 75.8, "name": "transposer_tiny", "height": 51}, "layers": {"c": {"z_offset": 1.2, "color": "Red", "features": ["C6_AB", "PNC1_AB", "PNC1_BC", "PNC1_CD", "PNC1_DE", "PNC1_EF", "PNC1_EG", "PNC2_AB", "PNC2_BC", "PNC2_DE", "C6_PA", "C6_PB", "VA1", "VA2", "VA3", "VA4", "VA5", "VA6"], "flip": true, "ID": "c"}, "f": {"z_offset": 0, "color": "Blue", "features": ["C1_AB", "C1_BC", "C1_CD", "C1_DE", "C1_EF", "C2_AB", "C3_AB", "C4_AB", "C5_AB", "VI1", "VI2", "urn:uuid:4d385be5-1fa5-4611-807d-6b52222f1604", "urn:uuid:e64b4a2a-0ac4-4a99-8b7c-8d91934e4f5c", "urn:uuid:f2794b9f-cabf-4f02-8f54-19d821f3731f", "urn:uuid:0e11b4bd-a071-421f-b1f8-4ae7eb26c7ec"], "flip": false, "ID": "f"}}, "features": {"C5_AB": {"layer": "f", "type": "channel", "feature_params": {"start": [30, 30.60000000000001], "height": 0.1, "end": [43.70000000000002, 30.60000000000001], "width": 0.2}, "ID": "C5_AB"}, "VI2": {"layer": "f", "type": "via", "feature_params": {"radius1": 0.6, "position": [39.900000000000006, 26.300000000000004], "radius2": 0.5, "height": 1.0999999999999999}, "ID": "VI2"}, "VI1": {"layer": "f", "type": "via", "feature_params": {"radius1": 0.6, "position": [33.900000000000006, 26.300000000000004], "radius2": 0.5, "height": 1.0999999999999999}, "ID": "VI1"}, "PNC1_BC": {"layer": "c", "type": "channel", "feature_params": {"start": [36.900000000000006, 20], "height": 0.4, "end": [32.0, 20], "width": 0.4}, "ID": "PNC1_BC"}, "C1_DE": {"layer": "f", "type": "channel", "feature_params": {"start": [36.900000000000006, 28.700000000000006], "height": 0.1, "end": [33.900000000000006, 28.700000000000006], "width": 0.2}, "ID": "C1_DE"}, "urn:uuid:e64b4a2a-0ac4-4a99-8b7c-8d91934e4f5c": {"layer": "f", "type": "standoff", "feature_params": {"radius1": 1.2, "position": [72.8, 3], "radius2": 1, "height": 1.2}, "ID": "urn:uuid:e64b4a2a-0ac4-4a99-8b7c-8d91934e4f5c"}, "PNC1_DE": {"layer": "c", "type": "channel", "feature_params": {"start": [32.0, 31.30000000000001], "height": 0.4, "end": [36.900000000000006, 31.30000000000001], "width": 0.4}, "ID": "PNC1_DE"}, "C2_AB": {"layer": "f", "type": "channel", "feature_params": {"start": [33.900000000000006, 22.0], "height": 0.1, "end": [33.900000000000006, 26.300000000000004], "width": 0.2}, "ID": "C2_AB"}, "C4_AB": {"layer": "f", "type": "channel", "feature_params": {"start": [30, 22.0], "height": 0.1, "end": [43.70000000000002, 22.0], "width": 0.2}, "ID": "C4_AB"}, "urn:uuid:f2794b9f-cabf-4f02-8f54-19d821f3731f": {"layer": "f", "type": "standoff", "feature_params": {"radius1": 1.2, "position": [72.8, 48], "radius2": 1, "height": 1.2}, "ID": "urn:uuid:f2794b9f-cabf-4f02-8f54-19d821f3731f"}, "C3_AB": {"layer": "f", "type": "channel", "feature_params": {"start": [39.900000000000006, 30.60000000000001], "height": 0.1, "end": [39.900000000000006, 26.300000000000004], "width": 0.2}, "ID": "C3_AB"}, "PNC2_AB": {"layer": "c", "type": "channel", "feature_params": {"start": [33.900000000000006, 23.900000000000002], "height": 0.4, "end": [41.80000000000001, 23.900000000000002], "width": 0.4}, "ID": "PNC2_AB"}, "C1_BC": {"layer": "f", "type": "channel", "feature_params": {"start": [39.900000000000006, 23.900000000000002], "height": 0.1, "end": [36.900000000000006, 23.900000000000002], "width": 0.2}, "ID": "C1_BC"}, "VA2": {"layer": "c", "type": "valve", "feature_params": {"radius1": 1.2, "position": [36.900000000000006, 22.0], "radius2": 1, "height": 0.8999999999999999}, "ID": "VA2"}, "VA3": {"layer": "c", "type": "valve", "feature_params": {"radius1": 1.2, "position": [39.900000000000006, 23.900000000000002], "radius2": 1, "height": 0.8999999999999999}, "ID": "VA3"}, "C1_CD": {"layer": "f", "type": "channel", "feature_params": {"start": [36.900000000000006, 23.900000000000002], "height": 0.1, "end": [36.900000000000006, 28.700000000000006], "width": 0.2}, "ID": "C1_CD"}, "VA6": {"layer": "c", "type": "valve", "feature_params": {"radius1": 1.2, "position": [39.900000000000006, 28.700000000000006], "radius2": 1, "height": 0.8999999999999999}, "ID": "VA6"}, "VA4": {"layer": "c", "type": "valve", "feature_params": {"radius1": 1.2, "position": [33.900000000000006, 28.700000000000006], "radius2": 1, "height": 0.8999999999999999}, "ID": "VA4"}, "VA5": {"layer": "c", "type": "valve", "feature_params": {"radius1": 1.2, "position": [36.900000000000006, 30.60000000000001], "radius2": 1, "height": 0.8999999999999999}, "ID": "VA5"}, "urn:uuid:4d385be5-1fa5-4611-807d-6b52222f1604": {"layer": "f", "type": "standoff", "feature_params": {"radius1": 1.2, "position": [3, 3], "radius2": 1, "height": 1.2}, "ID": "urn:uuid:4d385be5-1fa5-4611-807d-6b52222f1604"}, "PNC1_EF": {"layer": "c", "type": "channel", "feature_params": {"start": [36.900000000000006, 31.30000000000001], "height": 0.4, "end": [36.900000000000006, 30.60000000000001], "width": 0.4}, "ID": "PNC1_EF"}, "VA1": {"layer": "c", "type": "valve", "feature_params": {"radius1": 1.2, "position": [33.900000000000006, 23.900000000000002], "radius2": 1, "height": 0.8999999999999999}, "ID": "VA1"}, "PNC1_AB": {"layer": "c", "type": "channel", "feature_params": {"start": [36.900000000000006, 22.0], "height": 0.4, "end": [36.900000000000006, 20], "width": 0.4}, "ID": "PNC1_AB"}, "PNC1_EG": {"layer": "c", "type": "channel", "feature_params": {"start": [36.900000000000006, 31.30000000000001], "height": 0.4, "end": [36.900000000000006, 33.100000000000016], "width": 0.4}, "ID": "PNC1_EG"}, "C1_EF": {"layer": "f", "type": "channel", "feature_params": {"start": [33.900000000000006, 28.700000000000006], "height": 0.1, "end": [33.900000000000006, 30.60000000000001], "width": 0.2}, "ID": "C1_EF"}, "C6_PB": {"layer": "c", "type": "port", "feature_params": {"position": [39.900000000000006, 26.300000000000004], "radius": 0.5, "height": 0.1}, "ID": "C6_PB"}, "C6_PA": {"layer": "c", "type": "port", "feature_params": {"position": [33.900000000000006, 26.300000000000004], "radius": 0.5, "height": 0.1}, "ID": "C6_PA"}, "PNC2_DE": {"layer": "c", "type": "channel", "feature_params": {"start": [33.900000000000006, 28.700000000000006], "height": 0.4, "end": [41.80000000000001, 28.700000000000006], "width": 0.4}, "ID": "PNC2_DE"}, "C1_AB": {"layer": "f", "type": "channel", "feature_params": {"start": [39.900000000000006, 22.0], "height": 0.1, "end": [39.900000000000006, 23.900000000000002], "width": 0.2}, "ID": "C1_AB"}, "urn:uuid:0e11b4bd-a071-421f-b1f8-4ae7eb26c7ec": {"layer": "f", "type": "standoff", "feature_params": {"radius1": 1.2, "position": [3, 48], "radius2": 1, "height": 1.2}, "ID": "urn:uuid:0e11b4bd-a071-421f-b1f8-4ae7eb26c7ec"}, "C6_AB": {"layer": "c", "type": "channel", "feature_params": {"start": [33.900000000000006, 26.300000000000004], "height": 0.1, "end": [39.900000000000006, 26.300000000000004], "width": 0.2}, "ID": "C6_AB"}, "PNC1_CD": {"layer": "c", "type": "channel", "feature_params": {"start": [32.0, 20], "height": 0.4, "end": [32.0, 31.30000000000001], "width": 0.4}, "ID": "PNC1_CD"}, "PNC2_BC": {"layer": "c", "type": "channel", "feature_params": {"start": [41.80000000000001, 23.900000000000002], "height": 0.4, "end": [41.80000000000001, 33.100000000000016], "width": 0.4}, "ID": "PNC2_BC"}}}')

var setup_defaults = function()
{
	disable_grab();
	set_zoom(10);
	reset_view_position();
}

var reset_view_position = function()
{
	canvas.viewport.position = new fabric.Point(0,0);
}

var enable_grab = function()
{
	canvas.isGrabMode = true;
}

var disable_grab = function()
{
	canvas.isGrabMode = false;
}

var set_zoom = function(zoom_amount)
{
	canvas.setZoom(zoom_amount);
}

var adjust_zoom = function(zoom_modifier)
{
	set_zoom(canvas.viewport.zoom * zoom_modifier);
}

var flip_y_value = function(y_value)
{
	return json_data["device"]["height"] - y_value;
}

var clear_data = function()
{
	json_data = {};
	json_to_fabric = {};
	fabric_to_json = {};
	canvas.clear();
}

// ---------------------------------
// Default Fabric primitives 
// ---------------------------------

var default_background_line = function(start, end, width, color)
{
	var coords = [start[0], flip_y_value(start[1]), end[0], flip_y_value(end[1])];
	return new fabric.Line(
		coords, 
		{
			hasRotatingPoint: false,
			stroke: color,
   			strokeWidth: width,
   			selectable: false,
   			hasControls: false,
    		centeredScaling: true,
    		originY: 'center',
    		originX: 'center', 
    		lockRotation: true
    	}
    );
}

var default_circle = function(position, radius, color)
{
    return new fabric.Circle(
		{
			top: flip_y_value(position[1]),
			left: position[0],
			radius: radius,
			lockRotation: true, 
    		originX: 'center',
    		originY: 'center',
    		fill: color,
    		centeredScaling: true,
    		lockUniScaling: true,
    		hasRotatingPoint: false,
    		strokeWidth: 0
    	}
    );
}

var default_line = function(start, end, width, color)
{
	var coords = [start[0], flip_y_value(start[1]), end[0], flip_y_value(end[1])];
	return new fabric.Line(
		coords, 
		{
			hasRotatingPoint: false,
			stroke: color,
   			strokeWidth: width,
   			selectable: true,
   			hasControls: false,
    		centeredScaling: true,
    		originY: 'center',
    		originX: 'center', 
    		lockRotation: true
    	}
    );
}

// ---------------------------------
// JSON data parsing helper functions
// ---------------------------------

var get_feature_color = function(json_feature)
{
	if ("color" in json_feature)
	{
		return json_feature["color"]
	}
	else 
	{
		var layer = json_feature["layer"];
		return json_data["layers"][layer]["color"];
	}
}

var get_feature_params = function(json_feature)
{
	return json_feature["feature_params"];
}

var get_fab = function(json_feature)
{
	return json_to_fabric[json_feature["ID"]]
}

// ---------------------------------
// JSON <-> Fabric Handler Functions
// ---------------------------------

var cylinder_handler = function()
{
	this.create_fabric = function(cylinder_feature)
	{
		var params = get_feature_params(cylinder_feature);
		var position = params["position"]
		var radius = params["radius"];
		var color = get_feature_color(cylinder_feature);
		fab = default_circle(position, radius, color);
		fab.feature_ID = cylinder_feature["ID"];

		return fab;
	}

	this.update_json = function(fabric_cylinder)
	{
		var x = fabric_cylinder["left"];
		var y = flip_y_value(fabric_cylinder["top"]);
		var position = [x,y];
		var radius = fabric_cylinder["radius"] * fabric_cylinder["scaleX"];	
		params = {radius1: radius, position: position};
		update_json_feature(fabric_cylinder["feature_ID"], params);
	}
}

var channel_handler = function()
{
	this.create_fabric = function(channel_feature)
	{
		var params = get_feature_params(channel_feature);
		var start = params["start"];
		var end = params["end"];
		var width = params["width"];
		var color = get_feature_color(channel_feature);
		fab = default_line(start, end, width, color);
		fab.feature_ID = channel_feature["ID"];
		return fab;
	}

	this.update_json = function(fabric_channel)
	{
		var start = [fabric_channel["x1"], fabric_channel["y1"]];
		var end = [fabric_channel["x2"], fabric_channel["y2"]];
		var width = fabric_channel["strokeWidth"];
		params = {start: start, end: end, width: width};
		update_json_feature(fabric_channel["feature_ID"], params);
	}
}

var cone_handler = function()
{
	this.create_fabric = function(cone_feature)
	{
		var params = get_feature_params(cone_feature);
		var position = params["position"]
		var radius = params["radius1"];
		var color = get_feature_color(cone_feature);
		fab = default_circle(position, radius, color);
		fab.feature_ID = cone_feature["ID"];
		return fab;
	}

	this.update_json = function(fabric_cone)
	{
		var x = fabric_cone["left"];
		var y = flip_y_value(fabric_cone["top"]);
		var position = [x,y];
		var radius = fabric_cone["radius"] * fabric_cone["scaleX"];	
		params = {radius1: radius, position: position};
		update_json_feature(fabric_cone["feature_ID"], params);
	}
}

var update_json_feature = function(feature_ID, params)
{
	for (prop in params)
	{
		json_data["features"][feature_ID]["feature_params"][prop] = params[prop];
	}
}

var handlers =
{
	port: new cylinder_handler(),
	valve: new cone_handler(),
	via: new cone_handler(),
	standoff: new cone_handler(),
	valve: new cone_handler(),
	channel: new channel_handler()
};

var init_feature = function(json_feature)
{
	var type = json_feature["type"];
	var ID = json_feature["ID"];
	var handler = handlers[type];
	var new_fab = handler.create_fabric(json_feature);
	json_to_fabric[ID] = new_fab;
	canvas.add(new_fab);
	return new_fab;
}

var init_border = function()
{
	var device_data = json_data["device"];
	var width = device_data["width"];
	var height = device_data["height"];

	var topLeft = [0, height];
	var topRight = [width, height];
	var botLeft = [0, 0];
	var botRight = [width, 0];

	var lineWidth = .2;
	var color = 'black';

	canvas.add(default_background_line(topLeft, topRight, lineWidth, color));
	canvas.add(default_background_line(topLeft, botLeft, lineWidth, color));
	canvas.add(default_background_line(botLeft, botRight, lineWidth, color));
	canvas.add(default_background_line(botRight, topRight, lineWidth, color));
}

var update_from_fab_object = function(fab)
{
	console.log(fab);
	var type = fab.get('type');
	if (type == "group")
	{
		var children = fab.getObjects();
		for (child in children)
		{
			update_from_fab_object(children[child]);
		}
	}
	else {
		feature = json_data["features"][fab.feature_ID];
		type = feature["type"];
		handler = handlers[type];
		handler.update_json(fab);
	}
}

var init_all_features = function()
{
	var all_features = json_data["features"];
	for (feature_ID in all_features)
	{
		init_feature(all_features[feature_ID]);
	}
}

var export_to_svg = function()
{
	svg =  canvas.toSVG();
	var height_string_ori = 'height="' + canvas.height + '"';
	var width_string_ori = 'width="' + canvas.width + '"';
	var height_string_new = 'height="' + canvas.height + "mm" + '"';
	var width_string_new = 'width="' + canvas.width + "mm" + '"';
	var viewbox_string_new = ' viewBox="' + '0 0 ' + canvas.width + " " + canvas.height + '"';
	svg = svg.replace(width_string_ori, width_string_new);
	svg = svg.replace(height_string_ori, height_string_new + viewbox_string_new);
	return svg;
}

var import_json = function(json_object)
{
	clear_data();
	json_data = json_object;
}

var set_fab_inactive = function(fab)
{
	fab.set({selectable: false});
	fab.setOpacity(.5);
}

var load_all_layers = function(active_layer)
{
	canvas.clear();
	if (active_layer == null)
	{
		for (layer in json_data["layers"])
		{
			load_layer(layer, true);
		}
	}

	else {
		for (layer in json_data["layers"])
		{
			if (layer != active_layer)
			{
				load_layer(layer, false);
			}
		}
		load_layer(active_layer, true);
	}

	init_border();
}

var load_layer = function(layer_ID, active)
{
	var target_layer = json_data["layers"][layer_ID];
 	var layer_features = target_layer["features"];
 	for (feature in layer_features)
 	{
 		new_fab = init_feature(json_data["features"][layer_features[feature]]);
 		if (active == false)
 		{	
 			set_fab_inactive(new_fab);
 		}
	}
}

var count_json_features = function()
{
	var count = 0;
	for (feature in json_data["features"])
	{
		count++;
	}
	return count;
}

var count_layer_features = function(layer_ID)
{
	var count = 0;
	var layer = json_data["layers"][layer_ID];
	for (feature in layer["features"])
	{
		count++;
	}
	return count;
}

var count_all_layer_features = function()
{
	var count = 0;
	for (layer in json_data["layers"])
	{
		var layer_count = count_layer_features(layer);
		count += layer_count;
		console.log("Layer: " + layer + " has " + layer_count + " features.");
	}
	return count;
}

var count_active_fabs = function()
{
	return canvas.getObjects().length;
}

canvas = new fabric.CanvasWithViewport('c');
setup_defaults();
json_data = {};
import_json(test_json);
load_all_layers("c");
//load_layer("f");
//load_layer("c");
canvas.renderAll();
console.log("Total JSON features: " + count_json_features());
console.log("Total Fabric elements: " + count_active_fabs());
console.log("Total Layer features: " + count_all_layer_features());

canvas.on('object:modified', function(e)
{
	fab = e.target;
	update_from_fab_object(fab);
});