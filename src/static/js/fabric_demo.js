var big_ugly_JSON = JSON.parse('{"device": {"name": "transposer_med", "height": 51, "width": 75.8}, "layers": {"c": {"features": ["urn:uuid:7b2f768e-e99f-473d-bc73-47985ee9b0cf", "urn:uuid:7b2f768e-e99f-473d-bc73-47985ee9b0cf", "urn:uuid:946d6532-cf34-4b1d-8675-d93f6b998104", "urn:uuid:946d6532-cf34-4b1d-8675-d93f6b998104", "urn:uuid:0e110548-170e-44cd-9473-1f525ac75c1d", "urn:uuid:0e110548-170e-44cd-9473-1f525ac75c1d", "urn:uuid:55371b2e-150b-4a80-9256-e5b8d7f96c2c", "urn:uuid:55371b2e-150b-4a80-9256-e5b8d7f96c2c", "urn:uuid:5432fd20-c4d8-4e0f-a32b-81867f7a3ff0", "urn:uuid:5432fd20-c4d8-4e0f-a32b-81867f7a3ff0", "urn:uuid:6875b5c1-bd5d-4aca-86b0-97b1bdf24e22", "urn:uuid:6875b5c1-bd5d-4aca-86b0-97b1bdf24e22", "urn:uuid:6a907a99-0bb0-4538-89a6-1c44ff312894", "urn:uuid:6a907a99-0bb0-4538-89a6-1c44ff312894", "urn:uuid:2865a2cd-28c5-42f3-bb0d-4cc91438fb4f", "urn:uuid:2865a2cd-28c5-42f3-bb0d-4cc91438fb4f", "urn:uuid:82e731f3-0452-487b-b694-f33b5acff542", "urn:uuid:82e731f3-0452-487b-b694-f33b5acff542", "urn:uuid:d363683a-d9ac-4980-9d88-8526d6d9dffb", "urn:uuid:d363683a-d9ac-4980-9d88-8526d6d9dffb", "urn:uuid:daeb8b02-782d-48c9-b25d-07043f575c3e", "urn:uuid:daeb8b02-782d-48c9-b25d-07043f575c3e", "urn:uuid:cb4af447-a432-4991-a3db-d58aec3404c2", "urn:uuid:ef6f7d5a-6c6e-40c6-9d53-b39c375f6d14", "urn:uuid:a1b87ff2-1e13-4dc8-bdca-522f47f9a18c", "urn:uuid:38af6c40-ef06-412a-84c4-3b71e5a22f23", "urn:uuid:56cdc545-3fcc-42f0-b9b9-fd3672117808", "urn:uuid:f04653e7-4656-4f2c-8124-983e927b76f4", "urn:uuid:23f653c3-d221-4be0-8e66-d77fbb65674e", "urn:uuid:27f42484-b4b4-4acb-b515-d8e68e7bcd8a", "urn:uuid:fb47ba73-2ead-4fb6-87d4-679f38492f97", "urn:uuid:da122f20-5a39-4378-bf4c-43047f704138", "urn:uuid:7d7379b5-35b4-4a53-9de0-542987c8d881", "urn:uuid:128bd93d-ca0f-4320-b77b-98b660ecee3c", "urn:uuid:68387756-9e52-412c-a91b-c67563e300ba", "urn:uuid:1105d850-f116-449f-989d-82950af38d00"], "ID": "c", "flip": true, "color": "Red", "z_offset": 1.2}, "f": {"features": ["urn:uuid:a07eb02c-1491-44ca-b219-f05f6eea35e7", "urn:uuid:a07eb02c-1491-44ca-b219-f05f6eea35e7", "urn:uuid:48666511-d02a-4440-b901-2448de91f9f3", "urn:uuid:48666511-d02a-4440-b901-2448de91f9f3", "urn:uuid:0d13a06f-2af6-4a69-9f94-47b48fafd9f4", "urn:uuid:0d13a06f-2af6-4a69-9f94-47b48fafd9f4", "urn:uuid:9328da25-a0b7-4e25-9575-039b3bf6f556", "urn:uuid:9328da25-a0b7-4e25-9575-039b3bf6f556", "urn:uuid:c5ac53af-fd28-40ef-b99d-ca06c129ed32", "urn:uuid:c5ac53af-fd28-40ef-b99d-ca06c129ed32", "urn:uuid:f9179d54-62ca-492c-8b6c-589d5617f4fe", "urn:uuid:80e5b6c2-87d8-4f90-a7a5-1cb4bb6d336e", "urn:uuid:40e7709b-75c4-4eeb-901b-e2dfc3b3dffd", "urn:uuid:9d3c60bb-b473-4b03-a5c3-321697dce0fc", "urn:uuid:1a4dd466-ad47-476c-a75a-60d0bdb8fc1e", "urn:uuid:8b93590b-4ebe-4b93-a464-d874436e7186", "urn:uuid:f1905afe-254c-4651-aabe-3c37c47bc939", "urn:uuid:3ff94e71-6db9-4c97-909b-7b483d467a1a", "urn:uuid:6781df12-2f32-4002-9604-4ec71aaed8e5", "urn:uuid:3498af49-23df-49cc-909c-8dab3d4907c7", "urn:uuid:b48c3cb1-3e23-4f4f-a867-c044ee6f7cf7", "urn:uuid:9aff3255-d094-4eee-bc46-5accbb3d2f43", "urn:uuid:dfafadb4-18e0-4375-8455-a25a65acd55c", "urn:uuid:a989e9b2-370c-4422-bfd9-47bad317246b"], "ID": "f", "flip": false, "color": "Blue", "z_offset": 0}}, "features": {"urn:uuid:0d13a06f-2af6-4a69-9f94-47b48fafd9f4": {"ID": "urn:uuid:0d13a06f-2af6-4a69-9f94-47b48fafd9f4", "type": "channel", "layer": "f", "feature_params": {"start": [40.21, 20], "width": 0.41, "height": 0.1, "end": [40.21, 31.02]}}, "urn:uuid:5432fd20-c4d8-4e0f-a32b-81867f7a3ff0": {"ID": "urn:uuid:5432fd20-c4d8-4e0f-a32b-81867f7a3ff0", "type": "channel", "layer": "c", "feature_params": {"start": [40.21, 28.415], "width": 0.41, "height": 0.1, "end": [49.015, 28.415]}}, "urn:uuid:23f653c3-d221-4be0-8e66-d77fbb65674e": {"ID": "urn:uuid:23f653c3-d221-4be0-8e66-d77fbb65674e", "type": "port", "layer": "c", "feature_params": {"radius": 0.7, "height": 0.1, "position": [47.92, 20]}}, "urn:uuid:fb47ba73-2ead-4fb6-87d4-679f38492f97": {"ID": "urn:uuid:fb47ba73-2ead-4fb6-87d4-679f38492f97", "type": "valve", "layer": "c", "feature_params": {"radius2": 1.2, "radius1": 1.4, "height": 0.8999999999999999, "position": [37.11, 20]}}, "urn:uuid:a07eb02c-1491-44ca-b219-f05f6eea35e7": {"ID": "urn:uuid:a07eb02c-1491-44ca-b219-f05f6eea35e7", "type": "channel", "layer": "f", "feature_params": {"start": [30, 20], "width": 0.41, "height": 0.1, "end": [50.42, 20]}}, "urn:uuid:6a907a99-0bb0-4538-89a6-1c44ff312894": {"ID": "urn:uuid:6a907a99-0bb0-4538-89a6-1c44ff312894", "type": "channel", "layer": "c", "feature_params": {"start": [37.11, 20], "width": 0.41, "height": 0.1, "end": [31.405, 20]}}, "urn:uuid:1a4dd466-ad47-476c-a75a-60d0bdb8fc1e": {"ID": "urn:uuid:1a4dd466-ad47-476c-a75a-60d0bdb8fc1e", "type": "via", "layer": "f", "feature_params": {"radius2": 0.7, "radius1": 0.8, "height": 1.0999999999999999, "position": [34.010000000000005, 25.509999999999998]}}, "urn:uuid:1105d850-f116-449f-989d-82950af38d00": {"ID": "urn:uuid:1105d850-f116-449f-989d-82950af38d00", "type": "valve", "layer": "c", "feature_params": {"radius2": 1.2, "radius1": 1.4, "height": 0.8999999999999999, "position": [46.41, 28.415]}}, "urn:uuid:38af6c40-ef06-412a-84c4-3b71e5a22f23": {"ID": "urn:uuid:38af6c40-ef06-412a-84c4-3b71e5a22f23", "type": "port", "layer": "c", "feature_params": {"radius": 0.7, "height": 0.1, "position": [30, 31.02]}}, "urn:uuid:daeb8b02-782d-48c9-b25d-07043f575c3e": {"ID": "urn:uuid:daeb8b02-782d-48c9-b25d-07043f575c3e", "type": "channel", "layer": "c", "feature_params": {"start": [49.015, 22.605], "width": 0.41, "height": 0.1, "end": [50.42, 22.605]}}, "urn:uuid:f1905afe-254c-4651-aabe-3c37c47bc939": {"ID": "urn:uuid:f1905afe-254c-4651-aabe-3c37c47bc939", "type": "via", "layer": "f", "feature_params": {"radius2": 0.7, "radius1": 0.8, "height": 1.0999999999999999, "position": [30, 20]}}, "urn:uuid:7b2f768e-e99f-473d-bc73-47985ee9b0cf": {"ID": "urn:uuid:7b2f768e-e99f-473d-bc73-47985ee9b0cf", "type": "channel", "layer": "c", "feature_params": {"start": [34.010000000000005, 25.509999999999998], "width": 0.41, "height": 0.1, "end": [46.41, 25.509999999999998]}}, "urn:uuid:ef6f7d5a-6c6e-40c6-9d53-b39c375f6d14": {"ID": "urn:uuid:ef6f7d5a-6c6e-40c6-9d53-b39c375f6d14", "type": "port", "layer": "c", "feature_params": {"radius": 0.7, "height": 0.1, "position": [46.41, 25.509999999999998]}}, "urn:uuid:f9179d54-62ca-492c-8b6c-589d5617f4fe": {"ID": "urn:uuid:f9179d54-62ca-492c-8b6c-589d5617f4fe", "type": "port", "layer": "f", "feature_params": {"radius": 0.7, "height": 0.1, "position": [30, 20]}}, "urn:uuid:a1b87ff2-1e13-4dc8-bdca-522f47f9a18c": {"ID": "urn:uuid:a1b87ff2-1e13-4dc8-bdca-522f47f9a18c", "type": "port", "layer": "c", "feature_params": {"radius": 0.7, "height": 0.1, "position": [30, 20]}}, "urn:uuid:2865a2cd-28c5-42f3-bb0d-4cc91438fb4f": {"ID": "urn:uuid:2865a2cd-28c5-42f3-bb0d-4cc91438fb4f", "type": "channel", "layer": "c", "feature_params": {"start": [31.405, 31.02], "width": 0.41, "height": 0.1, "end": [43.31, 31.02]}}, "urn:uuid:a989e9b2-370c-4422-bfd9-47bad317246b": {"ID": "urn:uuid:a989e9b2-370c-4422-bfd9-47bad317246b", "type": "standoff", "layer": "f", "feature_params": {"radius2": 1.2, "radius1": 1.2, "height": 1.2, "position": [3, 48]}}, "urn:uuid:3ff94e71-6db9-4c97-909b-7b483d467a1a": {"ID": "urn:uuid:3ff94e71-6db9-4c97-909b-7b483d467a1a", "type": "via", "layer": "f", "feature_params": {"radius2": 0.7, "radius1": 0.8, "height": 1.0999999999999999, "position": [30, 31.02]}}, "urn:uuid:3498af49-23df-49cc-909c-8dab3d4907c7": {"ID": "urn:uuid:3498af49-23df-49cc-909c-8dab3d4907c7", "type": "via", "layer": "f", "feature_params": {"radius2": 0.7, "radius1": 0.8, "height": 1.0999999999999999, "position": [50.42, 31.02]}}, "urn:uuid:f04653e7-4656-4f2c-8124-983e927b76f4": {"ID": "urn:uuid:f04653e7-4656-4f2c-8124-983e927b76f4", "type": "port", "layer": "c", "feature_params": {"radius": 0.7, "height": 0.1, "position": [50.42, 31.02]}}, "urn:uuid:40e7709b-75c4-4eeb-901b-e2dfc3b3dffd": {"ID": "urn:uuid:40e7709b-75c4-4eeb-901b-e2dfc3b3dffd", "type": "port", "layer": "f", "feature_params": {"radius": 0.7, "height": 0.1, "position": [50.42, 20]}}, "urn:uuid:c5ac53af-fd28-40ef-b99d-ca06c129ed32": {"ID": "urn:uuid:c5ac53af-fd28-40ef-b99d-ca06c129ed32", "type": "channel", "layer": "f", "feature_params": {"start": [46.41, 31.02], "width": 0.41, "height": 0.1, "end": [46.41, 25.509999999999998]}}, "urn:uuid:82e731f3-0452-487b-b694-f33b5acff542": {"ID": "urn:uuid:82e731f3-0452-487b-b694-f33b5acff542", "type": "channel", "layer": "c", "feature_params": {"start": [31.405, 20], "width": 0.41, "height": 0.1, "end": [31.405, 31.02]}}, "urn:uuid:946d6532-cf34-4b1d-8675-d93f6b998104": {"ID": "urn:uuid:946d6532-cf34-4b1d-8675-d93f6b998104", "type": "channel", "layer": "c", "feature_params": {"start": [40.21, 28.415], "width": 0.41, "height": 0.1, "end": [46.41, 28.415]}}, "urn:uuid:b48c3cb1-3e23-4f4f-a867-c044ee6f7cf7": {"ID": "urn:uuid:b48c3cb1-3e23-4f4f-a867-c044ee6f7cf7", "type": "standoff", "layer": "f", "feature_params": {"radius2": 1.2, "radius1": 1.2, "height": 1.2, "position": [3, 3]}}, "urn:uuid:9d3c60bb-b473-4b03-a5c3-321697dce0fc": {"ID": "urn:uuid:9d3c60bb-b473-4b03-a5c3-321697dce0fc", "type": "port", "layer": "f", "feature_params": {"radius": 0.7, "height": 0.1, "position": [50.42, 31.02]}}, "urn:uuid:8b93590b-4ebe-4b93-a464-d874436e7186": {"ID": "urn:uuid:8b93590b-4ebe-4b93-a464-d874436e7186", "type": "via", "layer": "f", "feature_params": {"radius2": 0.7, "radius1": 0.8, "height": 1.0999999999999999, "position": [46.41, 25.509999999999998]}}, "urn:uuid:6781df12-2f32-4002-9604-4ec71aaed8e5": {"ID": "urn:uuid:6781df12-2f32-4002-9604-4ec71aaed8e5", "type": "via", "layer": "f", "feature_params": {"radius2": 0.7, "radius1": 0.8, "height": 1.0999999999999999, "position": [50.42, 20]}}, "urn:uuid:dfafadb4-18e0-4375-8455-a25a65acd55c": {"ID": "urn:uuid:dfafadb4-18e0-4375-8455-a25a65acd55c", "type": "standoff", "layer": "f", "feature_params": {"radius2": 1.2, "radius1": 1.2, "height": 1.2, "position": [72.8, 48]}}, "urn:uuid:9328da25-a0b7-4e25-9575-039b3bf6f556": {"ID": "urn:uuid:9328da25-a0b7-4e25-9575-039b3bf6f556", "type": "channel", "layer": "f", "feature_params": {"start": [34.010000000000005, 20], "width": 0.41, "height": 0.1, "end": [34.010000000000005, 25.509999999999998]}}, "urn:uuid:d363683a-d9ac-4980-9d88-8526d6d9dffb": {"ID": "urn:uuid:d363683a-d9ac-4980-9d88-8526d6d9dffb", "type": "channel", "layer": "c", "feature_params": {"start": [31.405, 20], "width": 0.41, "height": 0.1, "end": [47.92, 20]}}, "urn:uuid:0e110548-170e-44cd-9473-1f525ac75c1d": {"ID": "urn:uuid:0e110548-170e-44cd-9473-1f525ac75c1d", "type": "channel", "layer": "c", "feature_params": {"start": [40.21, 22.605], "width": 0.41, "height": 0.1, "end": [34.010000000000005, 22.605]}}, "urn:uuid:128bd93d-ca0f-4320-b77b-98b660ecee3c": {"ID": "urn:uuid:128bd93d-ca0f-4320-b77b-98b660ecee3c", "type": "valve", "layer": "c", "feature_params": {"radius2": 1.2, "radius1": 1.4, "height": 0.8999999999999999, "position": [40.21, 28.415]}}, "urn:uuid:6875b5c1-bd5d-4aca-86b0-97b1bdf24e22": {"ID": "urn:uuid:6875b5c1-bd5d-4aca-86b0-97b1bdf24e22", "type": "channel", "layer": "c", "feature_params": {"start": [49.015, 22.605], "width": 0.41, "height": 0.1, "end": [49.015, 28.415]}}, "urn:uuid:7d7379b5-35b4-4a53-9de0-542987c8d881": {"ID": "urn:uuid:7d7379b5-35b4-4a53-9de0-542987c8d881", "type": "valve", "layer": "c", "feature_params": {"radius2": 1.2, "radius1": 1.4, "height": 0.8999999999999999, "position": [40.21, 22.605]}}, "urn:uuid:56cdc545-3fcc-42f0-b9b9-fd3672117808": {"ID": "urn:uuid:56cdc545-3fcc-42f0-b9b9-fd3672117808", "type": "port", "layer": "c", "feature_params": {"radius": 0.7, "height": 0.1, "position": [50.42, 20]}}, "urn:uuid:80e5b6c2-87d8-4f90-a7a5-1cb4bb6d336e": {"ID": "urn:uuid:80e5b6c2-87d8-4f90-a7a5-1cb4bb6d336e", "type": "port", "layer": "f", "feature_params": {"radius": 0.7, "height": 0.1, "position": [30, 31.02]}}, "urn:uuid:9aff3255-d094-4eee-bc46-5accbb3d2f43": {"ID": "urn:uuid:9aff3255-d094-4eee-bc46-5accbb3d2f43", "type": "standoff", "layer": "f", "feature_params": {"radius2": 1.2, "radius1": 1.2, "height": 1.2, "position": [72.8, 3]}}, "urn:uuid:da122f20-5a39-4378-bf4c-43047f704138": {"ID": "urn:uuid:da122f20-5a39-4378-bf4c-43047f704138", "type": "valve", "layer": "c", "feature_params": {"radius2": 1.2, "radius1": 1.4, "height": 0.8999999999999999, "position": [43.31, 31.02]}}, "urn:uuid:68387756-9e52-412c-a91b-c67563e300ba": {"ID": "urn:uuid:68387756-9e52-412c-a91b-c67563e300ba", "type": "valve", "layer": "c", "feature_params": {"radius2": 1.2, "radius1": 1.4, "height": 0.8999999999999999, "position": [34.010000000000005, 22.605]}}, "urn:uuid:55371b2e-150b-4a80-9256-e5b8d7f96c2c": {"ID": "urn:uuid:55371b2e-150b-4a80-9256-e5b8d7f96c2c", "type": "channel", "layer": "c", "feature_params": {"start": [40.21, 22.605], "width": 0.41, "height": 0.1, "end": [49.015, 22.605]}}, "urn:uuid:cb4af447-a432-4991-a3db-d58aec3404c2": {"ID": "urn:uuid:cb4af447-a432-4991-a3db-d58aec3404c2", "type": "port", "layer": "c", "feature_params": {"radius": 0.7, "height": 0.1, "position": [34.010000000000005, 25.509999999999998]}}, "urn:uuid:48666511-d02a-4440-b901-2448de91f9f3": {"ID": "urn:uuid:48666511-d02a-4440-b901-2448de91f9f3", "type": "channel", "layer": "f", "feature_params": {"start": [30, 31.02], "width": 0.41, "height": 0.1, "end": [50.42, 31.02]}}, "urn:uuid:27f42484-b4b4-4acb-b515-d8e68e7bcd8a": {"ID": "urn:uuid:27f42484-b4b4-4acb-b515-d8e68e7bcd8a", "type": "port", "layer": "c", "feature_params": {"radius": 0.7, "height": 0.1, "position": [50.42, 22.605]}}}}');

var canvas = new fabric.CanvasWithViewport('c');
canvas.isGrabMode = false;
var selectedItem = null;
var fabric_features = {};
var features = {};
var layers = {};
var default_radius = 5;
var device_width = 70;
var device_height = 55;
var device_name = "Default_Device";
canvas.setZoom(canvas.viewport.zoom*10);
canvas.viewport.position = new fabric.Point(0,0);
var border = new fabric.Rect({left: 0, top:0, width: device_width, height: device_height, fill:'white', strokeWidth: 1, stroke:'black'});
canvas.add(border);
border.set({'selectable': false})

if (document.addEventListener) {
  // IE9, Chrome, Safari, Opera
  document.addEventListener("mousewheel", MouseWheelHandler, false);
  // Firefox
  document.addEventListener("DOMMouseScroll", MouseWheelHandler, false);
}
// IE 6/7/8
else document.attachEvent("onmousewheel", MouseWheelHandler);

function MouseWheelHandler(e) {

  // cross-browser wheel delta
  var e = window.event || e; // old IE support
  var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));
  if (delta > 0)
  {
    console.log("UP");
    canvas.setZoom(canvas.viewport.zoom*1.1);
  }
  else
  {
    console.log("DOWN");
    canvas.setZoom(canvas.viewport.zoom/1.1);
  }
  return false;
}

var merge = function() {
    var obj = {},
        i = 0,
        il = arguments.length,
        key;
    for (; i < il; i++) {
        for (key in arguments[i]) {
            if (arguments[i].hasOwnProperty(key)) {
                obj[key] = arguments[i][key];
            }
        }
    }
    return obj;
};

var feature = function(feature_data){
  this.layer = feature_data["target_layer"];
  this.ID = feature_data["ID"];
  this.featureType = feature_data["type"];
  if (feature_data["color"])
  {
    this.color = feature_data["color"];
  }
  else {
    this.color = layers[this.layer].color;
  }
}

feature.prototype.updateFabColor = function()
{
  if (this.fab)
  {
    this.fab.set({fill: this.color, stroke: this.color});
  }
  else {
    console.log("No fab to update for feature: " + this.ID);
  }
}

feature.prototype.feature_data = function(){
    var data = {};
    data["color"] = this.color;
    data["layer"] = this.layer;
    data["ID"] = this.ID;
    data["type"] = this.featureType;
    return data;
  };

var layer = function(layer_data){
    this.z_offset = layer_data["z_offset"];
    this.flip = layer_data["flip"];
    this.fabric_features = [];
    this.color = layer_data["color"];
    this.ID = layer_data["ID"];

  this.JSON_data = function()
  {
    var data = {};
    data["flip"] = this.flip;
    data["z_offset"] = this.z_offset;
    data["ID"] = this.ID;
    data["color"] = this.color;
    data["features"] = this.fabric_features;
    return data;
  }
}

var flipY = function(position)
{
  return [position[0], device_height - position[1]];
}

var via = function(feature_data){
    feature.call(this, {target_layer: feature_data["layer"], ID: feature_data["ID"], type: "via", color: feature_data["color"]});
    this.position = feature_data["feature_params"]["position"];
    this.radius1 = feature_data["feature_params"]["radius1"];
    this.radius2 = feature_data["feature_params"]["radius2"];
    this.height = feature_data["feature_params"]["height"];

  this.fab = new fabric.Circle({top: flipY(this.position)[1], left: this.position[0], radius: this.radius1, lockRotation: true, 
    originX: 'center', originY: 'center', fill: 'purple', lockUniScaling: true, originX: 'center', originY: 'center', strokeWidth: 0});
  this.updateFabColor();


  this.update = function()
  {
    this.position = flipY([this.fab.left, this.fab.top]);
    this.radius1 = this.fab.radius;
  }

  this.updateFab = function()
  {
    this.fab.set({radius: this.radius1, left: this.position[0], top: this.position[1]});
    this.updateFabColor();
  }

  this.JSON_data = function(){
    var data = {}
    data["feature_params"] = {}
    data["feature_params"]["position"] = this.position;
    data["feature_params"]["radius1"] = this.radius1;
    data["feature_params"]["radius2"] = this.radius2;
    data["feature_params"]["height"] = this.height;
    return merge(data, this.feature_data());
  }
}

via.prototype = Object.create(feature.prototype);
via.prototype.constructor = via;

var grabber = function(position, parent){
  this.featureType = "grabber"
  this.strokeWidth = 1
  this.radius = parent.fab['strokeWidth'] * .75;
  this.fab = new fabric.Circle({top: flipY(position)[1], left: position[0], hasBorders: false, hasControls: false,
    fill:'rgba(255,255,255,.5)', stroke: '#22F', strokeWidth: this.strokeWidth, radius: this.radius,
    originX: 'center', originY: 'center'});
  this.position = function(){
    return flipY([this.fab.left, this.fab.top]);
  }
  this.parent = parent;
}

var channel = function(feature_data)
{
  feature.call(this, {target_layer: feature_data["layer"], ID: feature_data["ID"], type: "channel", color: feature_data["color"]});
  this.grabbers = {}
  console.log(feature_data["feature_params"]);
  this.height = feature_data["feature_params"]["height"];
  this.start = feature_data["feature_params"]["start"];
  this.end = feature_data["feature_params"]["end"];
  this.width = feature_data["feature_params"]["width"];

  this.toFab = function(coords)
  {
    coords = [this.start[0], flipY(this.start)[1], this.end[0], flipY(this.end)[1]]
    return new fabric.Line(coords, {fill: 'red', stroke: 'red',
    strokeWidth: this.width, selectable: true, hasControls: false, lockScalingX: true, 
    lockScalingY: true, centeredScaling: true, originY: 'center', originX: 'center', 
    lockMovementX: true, lockMovementY: true, lockRotation: true});
  }

  this.fab = this.toFab()
  this.updateFabColor();

  this.update = function()
  {
    this.start = flipY([this.fab.x1, this.fab.y1]);
    this.end = flipY([this.fab.x2, this.fab.y2]);
    this.width = this.fab.strokeWidth * this.fab.scaleY;
  }

  this.makeGrabbers = function(canvas, fabric_features){
    if (this.grabbers['start'] == null && this.grabbers['end'] == null)
    {
      start = new grabber(this.start, this);
      start.fab.ID = this.ID + "_start_grabber";
      this.grabbers['start'] = start;
      canvas.add(start.fab);
      fabric_features[start.fab.ID] = start;
      end = new grabber(this.end, this);
      end.fab.ID = this.ID + "_end_grabber";
      this.grabbers['end'] = end;
      fabric_features[end.fab.ID] = end;
      canvas.add(end.fab);
    }
  }
  this.killGrabbers = function(canvas, fabric_features){
    if (this.grabbers['start']){
      canvas.remove(this.grabbers['start'].fab);
      fabric_features[this.grabbers['start'].fab.ID] = null;
      this.grabbers['start'] = null;
    }
    if (this.grabbers['end']){
      canvas.remove(this.grabbers['end'].fab);
      fabric_features[this.grabbers['end'].fab.ID] = null;
      this.grabbers['end'] = null;
    }
  }
  this.updateEnds = function(){
    if (this.grabbers['start']){
      var pos = flipY(this.grabbers['start'].position());
      this.fab.set({'x1': pos[0], 'y1': pos[1]});
    }
    if (this.grabbers['end']){
      var pos = flipY(this.grabbers['end'].position());
      this.fab.set({'x2': pos[0], 'y2': pos[1]});
    }
    this.update();
    canvas.remove(this.fab);
    canvas.add(this.fab);
  }
  this.JSON_data = function(){
    var data = {}
    data["feature_params"] = {}
    data["feature_params"]["start"] = flipY(this.start);
    data["feature_params"]["end"] = flipY(this.end);
    data["feature_params"]["width"] = this.width;
    data["feature_params"]["height"] = this.height;
    return merge(data, this.feature_data());
  }
  return this;
}

channel.prototype = Object.create(feature.prototype);
channel.prototype.constructor = channel;

var valve = function(feature_data)
{
  feature.call(this, {target_layer: feature_data["layer"], ID: feature_data["ID"], type: "valve", color: feature_data["color"]});
  this.radius1 = feature_data["feature_params"]["radius1"];
  this.radius2 = feature_data["feature_params"]["radius2"];
  this.position = feature_data["feature_params"]["position"];
  this.height = feature_data["feature_params"]["height"];
  this.fab = new fabric.Circle({radius: this.radius1, fill:'#f55', left: this.position[0], top: flipY(this.position)[1], lockUniScaling: true, lockRotation: true, centeredScaling: true, originX: 'center', originY: 'center', strokeWidth: 0});
  this.updateFabColor();

  this.update = function()
  {
    this.radius1 = this.fab.radius * this.fab.scaleX;
    this.position = flipY([this.fab.left, this.fab.top]);
  }
  this.JSON_data = function()
  {
    var data = {}
    data["feature_params"] = {}
    data["feature_params"]["position"] = this.position;
    data["feature_params"]["radius1"] = this.radius1;
    data["feature_params"]["radius2"] = this.radius2;
    data["feature_params"]["height"] = this.height;
    return merge(data, this.feature_data());
  }
  this.json
  return this;
}

valve.prototype = Object.create(feature.prototype);
valve.prototype.constructor = valve;

var standoff = function(feature_data)
{ 
  feature.call(this, {target_layer: feature_data["layer"], ID: feature_data["ID"], type: "standoff", color: feature_data["color"]});
  this.radius1 = feature_data["feature_params"]["radius1"];
  this.radius2 = feature_data["feature_params"]["radius2"];
  this.position = feature_data["feature_params"]["position"];
  this.height = feature_data["feature_params"]["height"];
  this.fab = new fabric.Circle({radius: this.radius1, fill:'yellow', left: this.position[0], top: flipY(this.position)[1], lockUniScaling: true, lockRotation: true, centeredScaling: true, originX: 'center', originY: 'center', strokeWidth: 0});
  this.updateFabColor();

  this.update = function()
  {
    this.radius1 = this.fab.radius * this.fab.scaleX;
    this.position = flipY([this.fab.left, this.fab.top]);
  }
  this.JSON_data = function()
  {
    var data = {}
    data["feature_params"] = {}
    data["feature_params"]["position"] = flipY(this.position);
    data["feature_params"]["radius1"] = this.radius1;
    data["feature_params"]["radius2"] = this.radius2;
    data["feature_params"]["height"] = this.height;
    return merge(data, this.feature_data());
  }
  return this;
}

standoff.prototype = Object.create(feature.prototype);
standoff.prototype.constructor = standoff;

valve.prototype = Object.create(feature.prototype);
valve.prototype.constructor = valve;

var label = function(feature_data)
{
  feature.call(this, {target_layer: feature_data["layer"], ID: feature_data["ID"], type: "label", color: feature_data["color"]});
  this.position = feature_data["position"];
  this.text = feature_data["text"];
  this.height = feature_data["height"];
  this.fab = new fabric.Text(this.text, {left: this.position[0], top: flipY(this.position)[1], hasControls: false, lockUniScaling: true, lockRotation: true, centeredScaling: true, originX: 'center', originY: 'center', strokeWidth: 0});
  this.updateFabColor();

  this.update = function()
  {
    this.position = flipY([this.fab.left, this.fab.top]);
    this.text = this.fab.text;
  }
  this.JSON_data = function()
  {
    var data = {}
    data["feature_params"] = {}
    data["feature_params"]["position"] = this.position;
    data["feature_params"]["label_text"] = this.text;
    data["feature_params"]["height"] = this.height;
    return merge(data, this.feature_data());
  }
  return this;
}

label.prototype = Object.create(feature.prototype);
label.prototype.constructor = label;

var port = function(feature_data)
{
  feature.call(this, {target_layer: feature_data["layer"], ID: feature_data["ID"], type: "port", color: feature_data["color"]});
  this.radius = feature_data["feature_params"]["radius"];
  this.position = feature_data["feature_params"]["position"];
  this.height = feature_data["feature_params"]["height"];
  this.fab = new fabric.Circle({radius: this.radius, fill:'green', left: this.position[0], top: flipY(this.position)[1], lockUniScaling: true, lockRotation: true, centeredScaling: true, originX: 'center', originY: 'center', strokeWidth: 0});
  this.updateFabColor();

  this.update = function()
  {
    this.radius = this.fab.radius * this.fab.scaleX;
    this.position = flipY([this.fab.left, this.fab.top]);
  }
  this.JSON_data = function()
  {
    var data = {}
    data["feature_params"] = {}
    data["feature_params"]["position"] = this.position;
    data["feature_params"]["radius"] = this.radius;
    data["feature_params"]["height"] = this.height;
    return merge(data, this.feature_data());
  }
  return this;
}

port.prototype = Object.create(feature.prototype);
port.prototype.constructor = port;

document.addEventListener('keydown', function(event){
	if (event.keyCode == 8 || event.keyCode == 46){
		if (selectedItem != null){

			selectedItem.remove();
		}
	}
	else if (event.keyCode == 16){
		alert(JSON.stringify(canvas));
	}
  else if (event.keyCode == 18)
  {
    if (selectedItem != null ){
      v = fabric_features[selectedItem]
      alert(v.reportString());
    }
  }
  });

var addFeature = function(feature){
  feature.fab.ID = feature.ID;
  fabric_features[feature.fab.ID] = feature;
  layers[feature.layer].fabric_features.push(feature.ID);
  canvas.add(feature.fab);
  features[feature.ID] = feature;
}

var addLayer = function(layer){
  layers[layer.ID] = layer;
}

var removeFeature = function(feature){
  if (fabric_features[feature]){
      fabric_features[feature] = null;
  }
  features[feature.ID] = null;
  canvas.remove(feature.fab);
  layer_fabric_features = layers[feature.layer].fabric_features;
  index = layer_fabric_features.indexOf(feature.ID);
  if (index > -1){
    layer_fabric_features.splice(index, 1);
  }
}

var load_device_data = function(device_data)
{
  device_height = device_data["height"];
  device_width = device_data["width"];
  device_name = device_data["name"];
}

var device_data = function()
{
  var data = {}
  data["width"] = device_width;
  data["height"] = device_height;
  data["name"] = device_name;
  return data;
}

var layer_data = function()
{
  var data = {}
  for (var layer_ID in layers)
  {
    var layer = layers[layer_ID];
    var layerData = layer.JSON_data();
    data[layer_ID] = layerData;
  }
  return data;
}

var load_feature = function(target_feature)
{
  var type = target_feature["type"];
  var fn = window[type];
  console.log(target_feature);
  new_feature = new fn(target_feature);
  addFeature(new_feature);  
}

var load_layer_data = function(layer_data)
{
  for (var target_layer in layer_data)
  {
    load_layer(layer_data[target_layer]);
  }
}

var feature_data = function()
{
  var data = {}
  for (var feature_ID in features){
    data[feature_ID] = features[feature_ID].JSON_data();
  }
  return data;
}

var load_feature_data = function(feature_data)
{
  for (var feature in feature_data)
  {
    load_feature(feature_data[feature]);
  }
}

var makeJSON = function()
{
   var JSON_data = {};
   JSON_data["device"] = device_data();
   JSON_data["features"] = feature_data();
   JSON_data["layers"] = layer_data();
  // console.log(layer_data());
   return JSON_data;
}

var clear_data = function()
{
  canvas.clear();
  fabric_features = {};
  layers = {};
  features = {};
  selectedItem = null;
}

var loadJSON = function(json_object)
{
  clear_data();
  load_device_data(json_object["device"]);
  border.set({width: device_width, height: device_height});
  canvas.add(border);
  load_layer_data(json_object["layers"]);
  load_feature_data(json_object["features"]);

}

var load_layer = function(target_layer)
{
  var l = new layer(target_layer);
  addLayer(l);
}


var foo = new layer({z_offset: 0, ID: "foo", flip: false, color: "blue"});
addLayer(foo);
var chan = new channel({
	feature_params: 
	{
		start:[10,20],
		end:[6,20],
		width:1.0, 
		height:1
	},
	layer: "foo",
	ID:'chan'});
var via1 = new via({feature_params: {position:[15,30], radius1:1.0, radius2:2}, layer: "foo", ID:'via1'});
var val1 = new valve({feature_params: {position:[20,20], radius1:2.0, radius2:3}, layer: "foo", ID:'val1'});
var port1 = new port({feature_params: {position:[40,10], radius:1.0}, layer: "foo", ID:'port1'});
var sta1 = new standoff({feature_params: {position:[5,50], radius1:2.0, radius2:3}, layer: "foo", ID:'sta1'});
addFeature(chan)
addFeature(via1)
addFeature(sta1)
addFeature(val1)
addFeature(port1)
var json_data = makeJSON();
//console.log(JSON.stringify(json_data));
loadJSON(big_ugly_JSON);


//chan.makeGrabbers(canvas, fabric_features);
canvas.on('object:moving', function(e){
  p = e.target;
  if (fabric_features[p.ID]){
    var feature = fabric_features[p.ID];
    if (feature.featureType == "grabber"){
      console.log("Moving a grabber!");
      parent = feature.parent;
      if (parent.featureType == "channel"){
        parent.updateEnds();
      }
    }
    else {
      feature.update();
    }
  }
});

canvas.on('mouse:down', function(options){
	if (!options.target || options.target == border)
	{
    console.log("Clicked on nothing...");
    if (selectedItem)
    {
      if (selectedItem.featureType == "channel"){
        console.log("Last selection was a channel, removing grabbers.");
        selectedItem.killGrabbers(canvas, fabric_features);
      }
    }
    if (selectedItem != null)
    {
      console.log("Clearing selection");
	   	selectedItem = null;
    }
	}
	else {
    console.log("Clicked on something!");
    var current = fabric_features[options.target.ID];
    if (current)
    {
      console.log("Current: " + current["ID"]);
      if (selectedItem != null)
      {
        console.log("Selected: " + selectedItem["ID"]);
      }
      if (selectedItem == null || current["ID"] != selectedItem["ID"])
      {
        console.log("Clicked on a new feature");
        if (current.featureType == "channel"){
          console.log("New feature is a channel");
          current.makeGrabbers(canvas, fabric_features);
        }
        if (selectedItem != null && selectedItem.featureType == "channel" && current.featureType != "grabber")
        {
          console.log("Last selection was a channel, removing grabbers.");
          selectedItem.killGrabbers(canvas, fabric_features);
        }
        if (current.featureType != "grabber"){
          console.log("Updating selection...");
          selectedItem = current;
        }
      }
      else {

      }
    }
	}
});

